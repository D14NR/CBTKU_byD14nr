<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT PRO - Sistem Ujian Online</title>
    
    <!-- Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts/dist/apexcharts.css">
    
    <style>
        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #b91c1c;
            --primary-red-light: #fee2e2;
            --secondary-red: #ef4444;
            --white: #ffffff;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --dark-text: #1f2937;
            --muted-text: #6b7280;
            --border-color: #e5e7eb;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --info-blue: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(220, 38, 38, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-red-hover);
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--dark-text);
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Auth Screen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-red) 0%, #991b1b 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: -150px;
            right: -150px;
        }

        .auth-container::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            bottom: -100px;
            left: -100px;
        }

        .auth-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            z-index: 1;
            position: relative;
            border: none;
            max-width: 1000px;
            width: 100%;
        }

        .auth-illustration {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .auth-illustration::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            border-radius: 50%;
            opacity: 0.1;
            top: -100px;
            right: -100px;
        }

        .auth-illustration::after {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            border-radius: 50%;
            opacity: 0.1;
            bottom: -75px;
            left: -75px;
        }

        .auth-features {
            list-style: none;
            padding: 0;
            margin: 30px 0;
        }

        .auth-features li {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--muted-text);
        }

        .auth-features li i {
            color: var(--primary-red);
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .auth-tabs {
            background: var(--light-bg);
            border-radius: 50px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .auth-tabs .nav-link {
            border-radius: 50px;
            font-weight: 500;
            color: var(--muted-text);
            transition: all 0.3s ease;
        }

        .auth-tabs .nav-link.active {
            background: var(--primary-red);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .form-floating {
            position: relative;
        }

        .form-floating .form-control {
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            height: auto;
            transition: all 0.3s ease;
        }

        .form-floating .form-control:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-floating label {
            color: var(--muted-text);
            padding: 16px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--muted-text);
            cursor: pointer;
            z-index: 5;
        }

        /* Dashboard */
        .dashboard-container {
            min-height: 100vh;
            background: var(--light-bg);
        }

        .dashboard-navbar {
            background: var(--white);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 0;
        }

        .dashboard-navbar .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-red);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: var(--light-bg);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark-text);
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--muted-text);
        }

        .dashboard-content {
            padding: 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-red);
        }

        .dashboard-card-primary {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            color: var(--white);
        }

        .dashboard-card-primary h4,
        .dashboard-card-primary p {
            color: var(--white) !important;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-red-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-red);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-text);
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--muted-text);
            font-size: 0.9rem;
        }

        .agenda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agenda-card {
            position: relative;
            overflow: hidden;
        }

        .agenda-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .agenda-status.active {
            background: #d1fae5;
            color: #065f46;
        }

        .agenda-status.upcoming {
            background: #fef3c7;
            color: #92400e;
        }

        .agenda-status.ended {
            background: #fee2e2;
            color: #991b1b;
        }

        .agenda-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted-text);
            font-size: 0.875rem;
            margin-bottom: 15px;
        }

        .agenda-time i {
            color: var(--primary-red);
        }

        .progress-wrapper {
            margin-top: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.875rem;
            color: var(--muted-text);
        }

        .progress-bar {
            height: 6px;
            background: var(--light-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Exam Interface */
        .exam-container {
            background: var(--light-bg);
            min-height: 100vh;
        }

        .exam-header {
            background: var(--white);
            box-shadow: var(--shadow-md);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exam-timer {
            background: var(--white);
            border: 2px solid var(--primary-red);
            border-radius: var(--radius-lg);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--primary-red);
            min-width: 180px;
        }

        .exam-timer.warning {
            animation: pulse 1.5s infinite;
            background: #fee2e2;
        }

        .exam-timer.danger {
            background: #fee2e2;
            color: #dc2626;
            border-color: #dc2626;
        }

        .exam-timer i {
            font-size: 1.2rem;
        }

        .exam-body {
            margin-top: 80px;
            padding: 30px;
        }

        .question-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-red);
        }

        .question-type {
            background: var(--light-bg);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--muted-text);
        }

        .question-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--dark-text);
            margin-bottom: 30px;
        }

        .question-image {
            max-width: 100%;
            border-radius: var(--radius-md);
            margin: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        /* Answer Options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option-item {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .option-item:hover {
            border-color: var(--primary-red);
            background: var(--primary-red-light);
            transform: translateX(5px);
        }

        .option-item.selected {
            border-color: var(--primary-red);
            background: var(--primary-red-light);
        }

        .option-item.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-red);
        }

        .option-label {
            width: 40px;
            height: 40px;
            min-width: 40px;
            background: var(--light-bg);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark-text);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .option-item.selected .option-label {
            background: var(--primary-red);
            color: var(--white);
        }

        .option-text {
            flex: 1;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Navigation Grid */
        .navigation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border-color);
            background: var(--white);
            border-radius: var(--radius-md);
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            transform: scale(1.05);
        }

        .nav-btn.active {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background: var(--primary-red-light);
            transform: scale(1.1);
        }

        .nav-btn.answered {
            background: var(--primary-red);
            color: var(--white);
            border-color: var(--primary-red);
        }

        .nav-btn.flagged {
            background: var(--warning-orange);
            color: var(--white);
            border-color: var(--warning-orange);
        }

        .nav-btn.review {
            background: var(--info-blue);
            color: var(--white);
            border-color: var(--info-blue);
        }

        /* Exam Controls */
        .exam-controls {
            background: var(--white);
            border-top: 2px solid var(--light-bg);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            z-index: 999;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            padding: 12px 30px;
            border-radius: var(--radius-md);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .control-btn-primary {
            background: var(--primary-red);
            color: var(--white);
        }

        .control-btn-primary:hover {
            background: var(--primary-red-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .control-btn-secondary {
            background: var(--white);
            color: var(--dark-text);
            border: 2px solid var(--border-color);
        }

        .control-btn-secondary:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .control-btn-finish {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            color: var(--white);
            font-weight: 700;
            padding: 15px 40px;
        }

        /* Connection Question */
        .connection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .connection-column {
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .connection-column h6 {
            margin-bottom: 20px;
            color: var(--dark-text);
            font-size: 1rem;
        }

        .connection-item {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-item:hover {
            border-color: var(--primary-red);
            transform: translateX(5px);
        }

        .connection-item.active {
            border-color: var(--primary-red);
            background: var(--primary-red-light);
        }

        .connection-item.connected {
            border-color: var(--success-green);
            background: #d1fae5;
        }

        .connection-number {
            width: 32px;
            height: 32px;
            background: var(--light-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--dark-text);
            flex-shrink: 0;
        }

        .connection-text {
            flex: 1;
        }

        .connections-display {
            background: var(--light-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
        }

        .connection-pair {
            display: inline-flex;
            align-items: center;
            background: var(--white);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 5px;
            font-weight: 500;
            border: 2px solid var(--border-color);
        }

        /* Essay Question */
        .essay-input {
            min-height: 200px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .essay-input:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            outline: none;
        }

        /* Table Question */
        .table-responsive {
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-custom th {
            background: var(--primary-red-light);
            color: var(--dark-text);
            font-weight: 600;
            border: none;
            padding: 15px;
        }

        .table-custom td {
            padding: 15px;
            border-color: var(--border-color);
            vertical-align: middle;
        }

        .table-custom tbody tr:hover {
            background: var(--light-bg);
        }

        /* Modal Styles */
        .modal-custom .modal-content {
            border-radius: var(--radius-xl);
            border: none;
            overflow: hidden;
        }

        .modal-custom .modal-header {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
            color: var(--white);
            border: none;
            padding: 25px 30px;
        }

        .modal-custom .modal-body {
            padding: 30px;
        }

        .modal-custom .modal-footer {
            border: none;
            padding: 20px 30px;
            background: var(--light-bg);
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loader-text {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1.1rem;
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        /* Utility Classes */
        .cursor-pointer {
            cursor: pointer;
        }

        .text-uppercase {
            text-transform: uppercase;
        }

        .fw-bold {
            font-weight: 600;
        }

        .fw-bolder {
            font-weight: 700;
        }

        .shadow-hover {
            transition: box-shadow 0.3s ease;
        }

        .shadow-hover:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .agenda-grid {
                grid-template-columns: 1fr;
            }

            .connection-container {
                grid-template-columns: 1fr;
            }

            .exam-header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .exam-body {
                padding: 20px;
                margin-top: 120px;
            }

            .question-card {
                padding: 20px;
            }

            .exam-controls {
                padding: 15px;
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
                justify-content: center;
            }

            .navigation-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --dark-text: #f3f4f6;
                --light-bg: #1f2937;
                --card-bg: #374151;
                --border-color: #4b5563;
                --muted-text: #9ca3af;
            }

            body {
                background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            }

            .dashboard-card,
            .question-card,
            .option-item,
            .connection-column {
                background: var(--card-bg);
            }

            .exam-header,
            .exam-controls {
                background: var(--card-bg);
            }
        }

        /* Results Dashboard */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-red);
        }

        .result-card h5 {
            color: var(--primary-red);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .result-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-text);
            line-height: 1;
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--muted-text);
        }

        /* Performance Chart */
        .performance-chart {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .performance-chart h5 {
            color: var(--dark-text);
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="loader-overlay d-none">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Memuat Sistem...</div>
    </div>

    <!-- Auth Screen -->
    <div id="viewAuth" class="auth-container">
        <div class="auth-card row g-0">
            <!-- Left Side - Illustration -->
            <div class="col-lg-6 auth-illustration d-none d-lg-flex flex-column justify-content-center">
                <div class="text-center mb-4">
                    <h1 class="text-gradient fw-bolder mb-3">CBT PRO</h1>
                    <p class="text-muted mb-4">Sistem Ujian Online Terintegrasi</p>
                </div>
                <div class="px-5">
                    <ul class="auth-features">
                        <li><i class="bi bi-shield-check"></i> Sistem Keamanan Tinggi</li>
                        <li><i class="bi bi-clock-history"></i> Timer Real-time</li>
                        <li><i class="bi bi-graph-up"></i> Analisis Hasil Otomatis</li>
                        <li><i class="bi bi-phone"></i> Responsif di Semua Device</li>
                        <li><i class="bi bi-cloud-check"></i> Auto-save Jawaban</li>
                        <li><i class="bi bi-file-earmark-text"></i> Multiple Question Types</li>
                    </ul>
                </div>
            </div>

            <!-- Right Side - Forms -->
            <div class="col-lg-6 p-5">
                <div class="text-center mb-5 d-lg-none">
                    <h1 class="text-gradient fw-bolder mb-2">CBT PRO</h1>
                    <p class="text-muted">Sistem Ujian Online Terintegrasi</p>
                </div>

                <!-- Tabs -->
                <div class="auth-tabs">
                    <ul class="nav nav-pills mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active w-100" data-bs-toggle="pill" data-bs-target="#tabLogin" type="button">
                                <i class="bi bi-box-arrow-in-right me-2"></i> Masuk
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#tabRegister" type="button" onclick="loadAgendaDropdown()">
                                <i class="bi bi-person-plus me-2"></i> Daftar
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Login Tab -->
                    <div class="tab-pane fade show active" id="tabLogin">
                        <form onsubmit="Auth.login(event)">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="loginUser" placeholder="Username/No WA" required>
                                <label for="loginUser"><i class="bi bi-person me-2"></i>Username / No WA</label>
                            </div>
                            <div class="form-floating mb-4 position-relative">
                                <input type="password" class="form-control" id="loginPass" placeholder="Password" required>
                                <label for="loginPass"><i class="bi bi-lock me-2"></i>Password</label>
                                <button type="button" class="password-toggle" onclick="togglePassword('loginPass', this)">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                            <button type="submit" class="btn btn-lg w-100 py-3 fw-bold shadow-hover" 
                                    style="background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%); color: white;">
                                <i class="bi bi-box-arrow-in-right me-2"></i> MASUK SEKARANG
                            </button>
                        </form>
                    </div>

                    <!-- Register Tab -->
                    <div class="tab-pane fade" id="tabRegister">
                        <form onsubmit="Auth.register(event)">
                            <div class="mb-3">
                                <select id="regAgenda" class="form-select py-3" required>
                                    <option value="">Memuat Agenda...</option>
                                </select>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <input type="text" id="regNama" class="form-control py-3" placeholder="Nama Lengkap" required>
                                </div>
                                <div class="col-md-6">
                                    <select id="regJenjang" class="form-select py-3" required>
                                        <option value="">Pilih Jenjang</option>
                                        <option value="SD">SD</option>
                                        <option value="SMP">SMP</option>
                                        <option value="SMA">SMA</option>
                                        <option value="SMK">SMK</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="regKelas" class="form-control py-3" placeholder="Kelas (Contoh: X IPA 1)" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <input type="text" id="regSekolah" class="form-control py-3" placeholder="Asal Sekolah" required>
                            </div>

                            <div class="mb-3">
                                <input type="tel" id="regWa" class="form-control py-3" placeholder="Nomor WhatsApp (Contoh: 81234567890)" required
                                       oninput="this.value = this.value.replace(/\D/g, '')">
                            </div>

                            <div class="mb-3">
                                <input type="tel" id="regWaOrtu" class="form-control py-3" placeholder="Nomor WhatsApp Orang Tua" required
                                       oninput="this.value = this.value.replace(/\D/g, '')">
                            </div>

                            <div class="form-floating mb-4 position-relative">
                                <input type="password" class="form-control" id="regPass" placeholder="Password" required>
                                <label for="regPass"><i class="bi bi-key me-2"></i>Password</label>
                                <button type="button" class="password-toggle" onclick="togglePassword('regPass', this)">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>

                            <button type="submit" class="btn btn-lg w-100 py-3 fw-bold shadow-hover"
                                    style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">
                                <i class="bi bi-person-plus me-2"></i> DAFTAR AKUN
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="viewDashboard" class="d-none">
        <nav class="dashboard-navbar">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <h2 class="navbar-brand mb-0">CBT<span class="text-gradient">PRO</span></h2>
                        <div class="d-none d-md-block">
                            <small class="text-muted">Sistem Ujian Online</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3">
                        <!-- Notification Bell -->
                        <div class="position-relative cursor-pointer" id="notificationBell">
                            <i class="bi bi-bell fs-5 text-muted"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                                0
                            </span>
                        </div>
                        
                        <!-- User Profile -->
                        <div class="user-profile" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">
                                <!-- Initials will be set by JS -->
                            </div>
                            <div class="user-info">
                                <div class="user-name" id="dashboardUserName">Loading...</div>
                                <div class="user-role">Peserta Ujian</div>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- User Menu Dropdown -->
        <div id="userMenu" class="position-absolute end-0 mt-2 me-3" style="display: none; z-index: 1001;">
            <div class="card shadow-lg border-0" style="min-width: 250px;">
                <div class="card-body p-0">
                    <div class="p-3 border-bottom">
                        <div class="d-flex align-items-center gap-3">
                            <div class="user-avatar" id="menuAvatar"></div>
                            <div>
                                <div class="fw-bold" id="menuUserName"></div>
                                <small class="text-muted" id="menuUserSchool"></small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" onclick="showProfile()">
                            <i class="bi bi-person me-2"></i> Profile Saya
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showResults()">
                            <i class="bi bi-graph-up me-2"></i> Hasil Ujian
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="changePassword()">
                            <i class="bi bi-key me-2"></i> Ganti Password
                        </a>
                        <div class="list-group-item list-group-item-action text-danger" onclick="Auth.logout()">
                            <i class="bi bi-box-arrow-right me-2"></i> Keluar
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Welcome Section -->
            <div class="dashboard-header animate-fadeIn">
                <div>
                    <h3 class="fw-bold mb-2">Selamat Datang, <span id="welcomeName"></span>! ðŸ‘‹</h3>
                    <p class="text-muted mb-0">Siap untuk ujian hari ini?</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-danger" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="dashboard-stats">
                <div class="dashboard-card">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="stat-number" id="statAgenda">0</div>
                    <div class="stat-label">Agenda Aktif</div>
                </div>
                <div class="dashboard-card">
                    <div class="stat-icon">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <div class="stat-number" id="statMapel">0</div>
                    <div class="stat-label">Mapel Tersedia</div>
                </div>
                <div class="dashboard-card">
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-number" id="statSelesai">0</div>
                    <div class="stat-label">Ujian Selesai</div>
                </div>
                <div class="dashboard-card">
                    <div class="stat-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="stat-number" id="statProgress">0%</div>
                    <div class="stat-label">Progress Belajar</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <h5 class="fw-bold mb-3">Akses Cepat</h5>
                        <div class="row g-3">
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-danger w-100 py-3" onclick="Dashboard.showAgenda()">
                                    <i class="bi bi-calendar-event fs-4 mb-2"></i>
                                    <div>Agenda Ujian</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-danger w-100 py-3" onclick="showResults()">
                                    <i class="bi bi-graph-up fs-4 mb-2"></i>
                                    <div>Hasil Ujian</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-danger w-100 py-3" onclick="showMaterials()">
                                    <i class="bi bi-journal-text fs-4 mb-2"></i>
                                    <div>Materi</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-danger w-100 py-3" onclick="showSettings()">
                                    <i class="bi bi-gear fs-4 mb-2"></i>
                                    <div>Pengaturan</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="dashboardContent">
                <!-- Agenda List (Default View) -->
                <div id="secAgenda" class="animate-fadeIn">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">ðŸ“… Agenda Ujian Tersedia</h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="filterAgenda('all')">Semua</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="filterAgenda('active')">Aktif</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="filterAgenda('upcoming')">Akan Datang</button>
                        </div>
                    </div>
                    <div id="agendaListContainer" class="agenda-grid"></div>
                </div>

                <!-- Token Verification -->
                <div id="secToken" class="d-none">
                    <div class="text-center animate-fadeIn">
                        <button class="btn btn-outline-danger mb-4" onclick="Dashboard.backToAgenda()">
                            <i class="bi bi-arrow-left"></i> Kembali ke Agenda
                        </button>
                        
                        <div class="card border-0 shadow-lg mx-auto" style="max-width: 500px;">
                            <div class="card-body p-5">
                                <div class="mb-4">
                                    <div class="text-danger mb-3">
                                        <i class="bi bi-shield-lock display-1"></i>
                                    </div>
                                    <h4 class="fw-bold mb-2" id="tokenAgendaName">Ujian</h4>
                                    <p class="text-muted">Masukkan token yang diberikan pengawas untuk memulai ujian</p>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="input-group input-group-lg">
                                        <input type="text" id="inputToken" class="form-control form-control-lg text-center fw-bold fs-2 border-danger"
                                               maxlength="5" placeholder="_____" style="letter-spacing: 10px;">
                                    </div>
                                    <small class="text-muted d-block mt-2">Token terdiri dari 5 karakter</small>
                                </div>
                                
                                <button class="btn btn-lg w-100 py-3 fw-bold shadow-hover" 
                                        style="background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%); color: white;"
                                        onclick="Dashboard.verifyToken()">
                                    <i class="bi bi-check-circle me-2"></i> VERIFIKASI TOKEN
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subject List -->
                <div id="secMapel" class="d-none">
                    <div class="animate-fadeIn">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4 class="fw-bold mb-1">ðŸ“š Mata Pelajaran</h4>
                                <p class="text-muted mb-0" id="mapelAgendaInfo"></p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-danger btn-sm" onclick="Dashboard.backToAgenda()">
                                    <i class="bi bi-arrow-left"></i> Ganti Agenda
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="refreshMapel()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="mapelListContainer" class="row g-3"></div>
                    </div>
                </div>

                <!-- Results View -->
                <div id="secResults" class="d-none">
                    <div class="animate-fadeIn">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold mb-0">ðŸ“Š Hasil Ujian</h4>
                            <button class="btn btn-outline-danger" onclick="Dashboard.show()">
                                <i class="bi bi-arrow-left"></i> Kembali
                            </button>
                        </div>
                        
                        <div id="resultsContainer">
                            <!-- Results will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Profile View -->
                <div id="secProfile" class="d-none">
                    <div class="animate-fadeIn">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold mb-0">ðŸ‘¤ Profile Saya</h4>
                            <button class="btn btn-outline-danger" onclick="Dashboard.show()">
                                <i class="bi bi-arrow-left"></i> Kembali
                            </button>
                        </div>
                        
                        <div id="profileContainer">
                            <!-- Profile will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Interface -->
    <div id="viewUjian" class="d-none">
        <div class="exam-header">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-danger btn-sm" onclick="showExamMenu()">
                    <i class="bi bi-list"></i>
                </button>
                <div>
                    <h6 class="fw-bold mb-0" id="ujianMapelName">Mata Pelajaran</h6>
                    <small class="text-muted d-none d-md-inline">Jangan refresh atau keluar halaman!</small>
                </div>
            </div>
            
            <div class="d-flex align-items-center gap-4">
                <!-- Question Counter -->
                <div class="text-center d-none d-md-block">
                    <div class="fw-bold" id="questionCounter">0/0</div>
                    <small class="text-muted">Soal</small>
                </div>
                
                <!-- Timer -->
                <div id="timerDisplay" class="exam-timer">
                    <i class="bi bi-clock"></i>
                    <span>00:00:00</span>
                </div>
                
                <!-- Save Status -->
                <div class="d-none d-md-block" id="saveStatus">
                    <small class="text-success"><i class="bi bi-check-circle"></i> Tersimpan</small>
                </div>
            </div>
        </div>

        <!-- Exam Menu (Sidebar) -->
        <div id="examMenu" class="position-fixed top-0 start-0 h-100 bg-white shadow-lg" style="width: 300px; z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease;">
            <div class="p-4 border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">Menu Ujian</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="hideExamMenu()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="text-muted small">
                    <div><i class="bi bi-info-circle me-2"></i>Navigasi soal dan kontrol ujian</div>
                </div>
            </div>
            
            <div class="p-4">
                <h6 class="fw-bold mb-3">Navigasi Soal</h6>
                <div id="navGridDesktop" class="navigation-grid mb-4"></div>
                
                <div class="mb-4">
                    <div class="d-flex gap-2 mb-2">
                        <div class="d-flex align-items-center gap-1">
                            <div class="nav-btn answered" style="width: 20px; height: 20px;"></div>
                            <small>Terjawab</small>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <div class="nav-btn flagged" style="width: 20px; height: 20px;"></div>
                            <small>Ragu-ragu</small>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <div class="nav-btn" style="width: 20px; height: 20px;"></div>
                            <small>Belum</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">Kontrol Ujian</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="Exam.saveProgress()">
                            <i class="bi bi-save me-2"></i> Simpan Sementara
                        </button>
                        <button class="btn btn-danger" onclick="Exam.finish(false)">
                            <i class="bi bi-flag-fill me-2"></i> Selesaikan Ujian
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-top">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="fullscreenToggle" onchange="toggleFullscreen()">
                        <label class="form-check-label" for="fullscreenToggle">Mode Layar Penuh</label>
                    </div>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="nightModeToggle" onchange="toggleNightMode()">
                        <label class="form-check-label" for="nightModeToggle">Mode Malam</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Content -->
        <div class="exam-body">
            <div class="row">
                <!-- Question Area -->
                <div class="col-lg-9">
                    <div id="soalContainer" class="question-card animate-fadeIn"></div>
                    
                    <!-- Navigation Buttons (Mobile) -->
                    <div class="d-flex justify-content-between gap-3 mt-4 d-lg-none">
                        <button class="control-btn control-btn-secondary w-50" id="btnPrev" onclick="Exam.navSoal(-1)">
                            <i class="bi bi-chevron-left"></i> Sebelumnya
                        </button>
                        <button class="control-btn control-btn-primary w-50" id="btnNext" onclick="Exam.navSoal(1)">
                            Selanjutnya <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Navigation Sidebar (Desktop) -->
                <div class="col-lg-3 d-none d-lg-block">
                    <div class="sticky-top" style="top: 90px;">
                        <div class="card border-0 shadow-lg mb-3">
                            <div class="card-header bg-white border-0">
                                <h6 class="fw-bold mb-0">Navigasi Soal</h6>
                            </div>
                            <div class="card-body p-3">
                                <div id="navGridDesktop2" class="navigation-grid mb-3"></div>
                                <div class="text-center">
                                    <small class="text-muted">Klik nomor untuk berpindah soal</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-lg">
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="checkRagu" onchange="Exam.toggleRagu()">
                                        <label class="form-check-label fw-bold text-warning" for="checkRagu">
                                            <i class="bi bi-question-circle"></i> Tandai Ragu-ragu
                                        </label>
                                    </div>
                                </div>
                                <button class="btn btn-danger w-100" onclick="Exam.finish(false)">
                                    <i class="bi bi-flag-fill me-2"></i> Selesaikan Ujian
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Controls (Mobile Footer) -->
        <div class="exam-controls d-lg-none">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="control-btn control-btn-secondary" id="btnPrevMobile" onclick="Exam.navSoal(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-danger btn-sm" onclick="toggleRaguMobile()">
                            <i class="bi bi-question-circle"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="showFinishModal()">
                            <i class="bi bi-flag"></i>
                        </button>
                    </div>
                    
                    <button class="control-btn control-btn-primary" id="btnNextMobile" onclick="Exam.navSoal(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Exam Rules Modal -->
    <div class="modal fade modal-custom" id="modalRules" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">ðŸ“‹ Tata Tertib Ujian</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <strong>Perhatian!</strong> Waktu akan mulai berjalan setelah Anda menekan tombol "Mulai Ujian"
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">ðŸ“ Aturan Umum</h6>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item px-0">1. Dilarang membuka tab atau aplikasi lain selama ujian</li>
                                <li class="list-group-item px-0">2. Sistem mendeteksi jika Anda keluar dari halaman ujian</li>
                                <li class="list-group-item px-0">3. Jangan merefresh halaman browser</li>
                                <li class="list-group-item px-0">4. Pastikan koneksi internet stabil</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">â±ï¸ Pengaturan Waktu</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item px-0">â€¢ Total waktu: <span id="examDurationInfo">0 menit</span></li>
                                <li class="list-group-item px-0">â€¢ Jumlah soal: <span id="examQuestionCount">0</span> butir</li>
                                <li class="list-group-item px-0">â€¢ Auto-save setiap 30 detik</li>
                                <li class="list-group-item px-0">â€¢ Warning 5 menit sebelum waktu habis</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="checkAgree">
                        <label class="form-check-label fw-bold" for="checkAgree">
                            Saya telah membaca, memahami, dan menyetujui semua aturan di atas
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" id="btnStartReal" disabled onclick="Exam.startReal()">
                        <i class="bi bi-play-fill me-2"></i> MULAI UJIAN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Violation Warning Modal -->
    <div class="modal fade" id="modalViolation" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <div class="text-danger mb-4">
                        <i class="bi bi-exclamation-octagon-fill display-1"></i>
                    </div>
                    <h3 class="fw-bold text-danger mb-3">PERINGATAN!</h3>
                    <p class="mb-4">Anda terdeteksi meninggalkan halaman ujian.</p>
                    <div class="alert alert-danger">
                        <h1 class="fw-bold display-3 mb-0" id="violationTimer">30</h1>
                        <small>detik tersisa sebelum auto-submit</small>
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <button id="btnResumeExam" class="btn btn-outline-dark" onclick="Exam.resume()">
                            <i class="bi bi-arrow-return-left me-2"></i> LANJUTKAN UJIAN
                        </button>
                        <button id="btnForceFinish" class="btn btn-danger d-none" onclick="Exam.finish(true)">
                            SELESAIKAN SEKARANG
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Finish Exam Modal -->
    <div class="modal fade" id="modalFinish" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">ðŸ Selesaikan Ujian</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-flag-fill text-danger display-1"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Apakah Anda yakin?</h5>
                    <p class="text-muted mb-4">Pastikan Anda telah memeriksa semua jawaban sebelum menyelesaikan ujian.</p>
                    
                    <div class="alert alert-info text-start">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle"></i>
                            </div>
                            <div>
                                <small>
                                    <strong>Status Jawaban:</strong><br>
                                    â€¢ Terjawab: <span id="answeredCount">0</span> soal<br>
                                    â€¢ Ragu-ragu: <span id="flaggedCount">0</span> soal<br>
                                    â€¢ Belum dijawab: <span id="unansweredCount">0</span> soal
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Periksa Lagi</button>
                    <button type="button" class="btn btn-danger" onclick="Exam.finish(false)">Ya, Selesaikan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Success Modal -->
    <div class="modal fade" id="modalKartu" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-success">âœ… Registrasi Berhasil!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-4 mb-3">
                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                        </div>
                        <p class="text-muted">Akun Anda telah berhasil dibuat. Simpan kartu peserta berikut:</p>
                    </div>
                    
                    <div class="card border-0 shadow-sm" id="kartuArea">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <h6 class="fw-bold border-bottom pb-3 mb-0">ðŸŽ“ KARTU PESERTA UJIAN</h6>
                            </div>
                            <table class="table table-borderless mb-0">
                                <tr>
                                    <td width="120"><small>Nama Lengkap</small></td>
                                    <td class="fw-bold" id="cardNama">-</td>
                                </tr>
                                <tr>
                                    <td><small>Username</small></td>
                                    <td>
                                        <span class="badge bg-danger" id="cardUser">-</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><small>Password</small></td>
                                    <td class="fw-bold" id="cardPass">-</td>
                                </tr>
                                <tr>
                                    <td><small>Agenda</small></td>
                                    <td id="cardAgenda">-</td>
                                </tr>
                                <tr>
                                    <td><small>Tanggal Daftar</small></td>
                                    <td id="cardDate">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-warning small">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Simpan atau screenshot kartu ini untuk login ke sistem
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-outline-danger w-100 mb-2" onclick="downloadKartu()">
                        <i class="bi bi-download me-2"></i> Download Kartu
                    </button>
                    <button class="btn btn-danger w-100" onclick="tutupKartuKeLogin()">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Login Sekarang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="modalProfile" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">ðŸ‘¤ Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Profile form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        // Global State Management
        const App = {
            state: {
                user: null,
                agendaId: null,
                mapelList: [],
                activeMapel: null,
                tempMapelId: null,
                soal: [],
                jawaban: [],
                ragu: [],
                endTime: 0,
                timer: null,
                currentSoalIdx: 0,
                dashInterval: null,
                cheatTimer: 30,
                cheatInterval: null,
                selectedLeftIndex: null,
                autoSaveInterval: null,
                lastSaveTime: null,
                examStats: {
                    totalSoal: 0,
                    terjawab: 0,
                    diragukan: 0,
                    belumDijawab: 0
                }
            },
            
            ui: {
                showLoader: (show, text = 'Memuat...') => {
                    document.getElementById('loaderText').innerText = text;
                    document.getElementById('loader').classList.toggle('d-none', !show);
                },
                
                showView: (viewId) => {
                    ['viewAuth', 'viewDashboard', 'viewUjian'].forEach(v => {
                        document.getElementById(v).classList.add('d-none');
                    });
                    document.getElementById(viewId).classList.remove('d-none');
                },
                
                showNotification: (title, message, type = 'info') => {
                    const icon = {
                        success: 'âœ…',
                        error: 'âŒ',
                        warning: 'âš ï¸',
                        info: 'â„¹ï¸'
                    }[type];
                    
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification(`${icon} ${title}`, {
                            body: message,
                            icon: '/favicon.ico'
                        });
                    }
                    
                    // Update badge
                    const badge = document.getElementById('notificationBadge');
                    let count = parseInt(badge.textContent || '0');
                    badge.textContent = count + 1;
                    badge.style.display = 'block';
                }
            },
            
            storage: {
                save: (key, value) => {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                    } catch (e) {
                        console.warn('LocalStorage error:', e);
                    }
                },
                
                get: (key) => {
                    try {
                        return JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        console.warn('LocalStorage error:', e);
                        return null;
                    }
                },
                
                remove: (key) => {
                    localStorage.removeItem(key);
                },
                
                clearExamData: () => {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('exam_') || key.startsWith('ans_')) {
                            localStorage.removeItem(key);
                        }
                    });
                }
            }
        };

        // Password Toggle Function
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            }
        }

        // Auth Module
        const Auth = {
            init: () => {
                // Check for saved user
                const savedUser = App.storage.get('cbt_user');
                if (savedUser) {
                    App.state.user = savedUser;
                    Dashboard.show();
                } else {
                    App.ui.showView('viewAuth');
                }
                
                // Request notification permission
                if ('Notification' in window) {
                    Notification.requestPermission();
                }
            },
            
            login: async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUser').value.trim();
                const password = document.getElementById('loginPass').value.trim();
                
                if (!username || !password) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Data tidak lengkap',
                        text: 'Harap isi username dan password',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                App.ui.showLoader(true, 'Memproses login...');
                
                try {
                    // Simulate API call - replace with actual Google Apps Script call
                    const response = await mockLogin(username, password);
                    
                    if (response.success) {
                        App.state.user = response.data;
                        App.storage.save('cbt_user', response.data);
                        
                        // Update user avatar
                        updateUserAvatar();
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Login Berhasil!',
                            text: `Selamat datang ${response.data.nama_peserta}`,
                            timer: 2000,
                            showConfirmButton: false,
                            timerProgressBar: true
                        });
                        
                        // Show dashboard
                        setTimeout(() => {
                            App.ui.showLoader(false);
                            Dashboard.show();
                        }, 500);
                    } else {
                        App.ui.showLoader(false);
                        Swal.fire({
                            icon: 'error',
                            title: 'Login Gagal',
                            text: response.message,
                            confirmButtonColor: '#dc2626'
                        });
                    }
                } catch (error) {
                    App.ui.showLoader(false);
                    Swal.fire({
                        icon: 'error',
                        title: 'Terjadi Kesalahan',
                        text: error.message,
                        confirmButtonColor: '#dc2626'
                    });
                }
            },
            
            register: async (e) => {
                e.preventDefault();
                
                const formData = {
                    agenda_id: document.getElementById('regAgenda').value,
                    nama: document.getElementById('regNama').value.trim(),
                    jenjang: document.getElementById('regJenjang').value,
                    kelas: document.getElementById('regKelas').value.trim(),
                    sekolah: document.getElementById('regSekolah').value.trim(),
                    no_wa: document.getElementById('regWa').value.trim(),
                    wa_ortu: document.getElementById('regWaOrtu').value.trim(),
                    password: document.getElementById('regPass').value,
                    username: document.getElementById('regWa').value.trim()
                };
                
                // Validation
                if (!formData.agenda_id || !formData.nama || !formData.jenjang || !formData.kelas || 
                    !formData.sekolah || !formData.no_wa || !formData.wa_ortu || !formData.password) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Data tidak lengkap',
                        text: 'Harap lengkapi semua field',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                if (formData.no_wa.length < 10) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Nomor WhatsApp tidak valid',
                        text: 'Harap masukkan nomor WhatsApp yang valid',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                App.ui.showLoader(true, 'Mendaftarkan akun...');
                
                try {
                    // Simulate API call - replace with actual Google Apps Script call
                    const response = await mockRegister(formData);
                    
                    if (response.success) {
                        // Show success modal
                        document.getElementById('cardNama').textContent = formData.nama;
                        document.getElementById('cardUser').textContent = formData.username;
                        document.getElementById('cardPass').textContent = formData.password;
                        document.getElementById('cardAgenda').textContent = response.nama_agenda || 'Ujian';
                        document.getElementById('cardDate').textContent = new Date().toLocaleDateString('id-ID');
                        
                        App.ui.showLoader(false);
                        
                        // Show registration card modal
                        const modal = new bootstrap.Modal(document.getElementById('modalKartu'));
                        modal.show();
                        
                        // Reset form
                        e.target.reset();
                    } else {
                        App.ui.showLoader(false);
                        Swal.fire({
                            icon: 'error',
                            title: 'Registrasi Gagal',
                            text: response.message,
                            confirmButtonColor: '#dc2626'
                        });
                    }
                } catch (error) {
                    App.ui.showLoader(false);
                    Swal.fire({
                        icon: 'error',
                        title: 'Terjadi Kesalahan',
                        text: error.message,
                        confirmButtonColor: '#dc2626'
                    });
                }
            },
            
            logout: () => {
                Swal.fire({
                    title: 'Konfirmasi Logout',
                    text: 'Apakah Anda yakin ingin keluar dari sistem?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Ya, Keluar',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Clear all intervals
                        if (App.state.dashInterval) clearInterval(App.state.dashInterval);
                        if (App.state.timer) clearInterval(App.state.timer);
                        if (App.state.cheatInterval) clearInterval(App.state.cheatInterval);
                        if (App.state.autoSaveInterval) clearInterval(App.state.autoSaveInterval);
                        
                        // Clear storage
                        App.storage.remove('cbt_user');
                        App.storage.clearExamData();
                        
                        // Reset state
                        App.state = {
                            user: null,
                            agendaId: null,
                            mapelList: [],
                            activeMapel: null,
                            tempMapelId: null,
                            soal: [],
                            jawaban: [],
                            ragu: [],
                            endTime: 0,
                            timer: null,
                            currentSoalIdx: 0,
                            dashInterval: null,
                            cheatTimer: 30,
                            cheatInterval: null,
                            selectedLeftIndex: null,
                            autoSaveInterval: null,
                            lastSaveTime: null,
                            examStats: {
                                totalSoal: 0,
                                terjawab: 0,
                                diragukan: 0,
                                belumDijawab: 0
                            }
                        };
                        
                        // Reset form
                        document.getElementById('loginUser').value = '';
                        document.getElementById('loginPass').value = '';
                        
                        // Show auth screen
                        App.ui.showView('viewAuth');
                        
                        // Show logout message
                        Swal.fire({
                            icon: 'success',
                            title: 'Logout Berhasil',
                            text: 'Anda telah keluar dari sistem',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            }
        };

        // Dashboard Module
        const Dashboard = {
            show: () => {
                App.ui.showView('viewDashboard');
                
                // Update user info
                if (App.state.user) {
                    document.getElementById('dashboardUserName').textContent = App.state.user.nama_peserta;
                    document.getElementById('welcomeName').textContent = App.state.user.nama_peserta.split(' ')[0];
                    
                    // Update avatar
                    updateUserAvatar();
                    
                    // Update menu info
                    document.getElementById('menuUserName').textContent = App.state.user.nama_peserta;
                    document.getElementById('menuUserSchool').textContent = App.state.user.asal_sekolah;
                }
                
                // Show agenda section by default
                this.showAgenda();
                
                // Load dashboard stats
                this.loadDashboardStats();
            },
            
            showAgenda: () => {
                document.getElementById('secAgenda').classList.remove('d-none');
                document.getElementById('secToken').classList.add('d-none');
                document.getElementById('secMapel').classList.add('d-none');
                document.getElementById('secResults').classList.add('d-none');
                document.getElementById('secProfile').classList.add('d-none');
                
                this.loadAgendaList();
            },
            
            loadAgendaList: () => {
                const container = document.getElementById('agendaListContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger mb-3"></div>
                            <p class="text-muted">Memuat agenda ujian...</p>
                        </div>
                    </div>
                `;
                
                // Simulate API call - replace with actual Google Apps Script call
                setTimeout(() => {
                    const mockAgenda = [
                        {
                            id: 1,
                            agenda_ujian: "Ujian Tengah Semester Genap 2024",
                            tgljam_mulai: new Date(Date.now() + 3600000).toISOString(),
                            tgljam_selesai: new Date(Date.now() + 10800000).toISOString(),
                            status: "upcoming"
                        },
                        {
                            id: 2,
                            agenda_ujian: "Ujian Harian Matematika",
                            tgljam_mulai: new Date(Date.now() - 3600000).toISOString(),
                            tgljam_selesai: new Date(Date.now() + 7200000).toISOString(),
                            status: "active"
                        },
                        {
                            id: 3,
                            agenda_ujian: "Try Out UNBK 2024",
                            tgljam_mulai: new Date(Date.now() - 86400000).toISOString(),
                            tgljam_selesai: new Date(Date.now() - 43200000).toISOString(),
                            status: "ended"
                        }
                    ];
                    
                    container.innerHTML = '';
                    
                    mockAgenda.forEach(agenda => {
                        const startTime = new Date(agenda.tgljam_mulai);
                        const endTime = new Date(agenda.tgljam_selesai);
                        const now = new Date();
                        
                        let statusClass = '';
                        let statusText = '';
                        let progress = 0;
                        
                        if (now < startTime) {
                            statusClass = 'upcoming';
                            statusText = 'AKAN DATANG';
                            progress = 0;
                        } else if (now >= startTime && now <= endTime) {
                            statusClass = 'active';
                            statusText = 'SEDANG BERLANGSUNG';
                            progress = ((now - startTime) / (endTime - startTime)) * 100;
                        } else {
                            statusClass = 'ended';
                            statusText = 'SELESAI';
                            progress = 100;
                        }
                        
                        container.innerHTML += `
                            <div class="col-12">
                                <div class="dashboard-card agenda-card">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="fw-bold mb-2">${agenda.agenda_ujian}</h5>
                                            <div class="agenda-time">
                                                <i class="bi bi-calendar"></i>
                                                <span>${startTime.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                            </div>
                                            <div class="agenda-time">
                                                <i class="bi bi-clock"></i>
                                                <span>${startTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span>
                                            </div>
                                        </div>
                                        <span class="agenda-status ${statusClass}">${statusText}</span>
                                    </div>
                                    
                                    <div class="progress-wrapper">
                                        <div class="progress-label">
                                            <span>Progress</span>
                                            <span>${Math.round(progress)}%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${progress}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-4">
                                        <button class="btn btn-outline-danger flex-fill" onclick="Dashboard.viewAgendaDetails(${agenda.id})">
                                            <i class="bi bi-info-circle me-2"></i> Detail
                                        </button>
                                        <button class="btn btn-danger flex-fill" onclick="Dashboard.openToken(${agenda.id}, '${agenda.agenda_ujian}')" ${statusClass !== 'active' ? 'disabled' : ''}>
                                            <i class="bi bi-play-circle me-2"></i> Mulai Ujian
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }, 1000);
            },
            
            openToken: (id, name) => {
                App.state.agendaId = id;
                document.getElementById('secAgenda').classList.add('d-none');
                document.getElementById('secToken').classList.remove('d-none');
                document.getElementById('tokenAgendaName').textContent = name;
                document.getElementById('inputToken').value = '';
                document.getElementById('inputToken').focus();
            },
            
            backToAgenda: () => {
                this.showAgenda();
            },
            
            verifyToken: () => {
                const token = document.getElementById('inputToken').value.trim().toUpperCase();
                
                if (!token || token.length !== 5) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Token tidak valid',
                        text: 'Token harus terdiri dari 5 karakter',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                App.ui.showLoader(true, 'Memverifikasi token...');
                
                // Simulate API call - replace with actual Google Apps Script call
                setTimeout(() => {
                    App.ui.showLoader(false);
                    
                    // Mock verification - always success for demo
                    if (token === '12345' || token === 'ABCDE') {
                        this.refreshMapel();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Token Salah',
                            text: 'Token yang Anda masukkan tidak valid',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                }, 1500);
            },
            
            refreshMapel: () => {
                App.ui.showView('viewDashboard');
                document.getElementById('secToken').classList.add('d-none');
                document.getElementById('secMapel').classList.remove('d-none');
                
                // Update agenda info
                document.getElementById('mapelAgendaInfo').textContent = 
                    `Agenda: ${document.getElementById('tokenAgendaName').textContent}`;
                
                this.loadMapelList();
            },
            
            loadMapelList: () => {
                const container = document.getElementById('mapelListContainer');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger mb-3"></div>
                            <p class="text-muted">Memuat mata pelajaran...</p>
                        </div>
                    </div>
                `;
                
                // Simulate API call - replace with actual Google Apps Script call
                setTimeout(() => {
                    const mockMapel = [
                        {
                            id: 1,
                            nama_mata_pelajaran: "Matematika",
                            jumlah_soal: 40,
                            durasi_ujian: 120,
                            status_kerjakan: "Belum",
                            nilai: null
                        },
                        {
                            id: 2,
                            nama_mata_pelajaran: "Bahasa Indonesia",
                            jumlah_soal: 50,
                            durasi_ujian: 90,
                            status_kerjakan: "Proses",
                            nilai: null
                        },
                        {
                            id: 3,
                            nama_mata_pelajaran: "IPA",
                            jumlah_soal: 45,
                            durasi_ujian: 100,
                            status_kerjakan: "Selesai",
                            nilai: 85
                        },
                        {
                            id: 4,
                            nama_mata_pelajaran: "Bahasa Inggris",
                            jumlah_soal: 35,
                            durasi_ujian: 80,
                            status_kerjakan: "Belum",
                            nilai: null
                        }
                    ];
                    
                    container.innerHTML = '';
                    
                    mockMapel.forEach(mapel => {
                        let statusBadge = '';
                        let button = '';
                        let scoreInfo = '';
                        
                        if (mapel.status_kerjakan === 'Selesai') {
                            statusBadge = '<span class="badge bg-success">SELESAI</span>';
                            button = `
                                <button class="btn btn-success w-100" onclick="viewExamResult(${mapel.id})">
                                    <i class="bi bi-graph-up me-2"></i> Lihat Hasil
                                </button>
                            `;
                            scoreInfo = `
                                <div class="mt-2">
                                    <small class="text-muted">Nilai: </small>
                                    <span class="fw-bold text-success">${mapel.nilai}</span>
                                </div>
                            `;
                        } else if (mapel.status_kerjakan === 'Proses') {
                            statusBadge = '<span class="badge bg-warning">PROSES</span>';
                            button = `
                                <button class="btn btn-warning w-100" onclick="Exam.continueExam(${mapel.id})">
                                    <i class="bi bi-play-circle me-2"></i> Lanjutkan
                                </button>
                            `;
                        } else {
                            statusBadge = '<span class="badge bg-secondary">BELUM</span>';
                            button = `
                                <button class="btn btn-danger w-100" onclick="Exam.confirm(${mapel.id})">
                                    <i class="bi bi-play-fill me-2"></i> Mulai Ujian
                                </button>
                            `;
                        }
                        
                        container.innerHTML += `
                            <div class="col-md-6 col-lg-3">
                                <div class="dashboard-card h-100">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="fw-bold mb-1">${mapel.nama_mata_pelajaran}</h6>
                                            ${statusBadge}
                                        </div>
                                        <i class="bi bi-journal-text fs-4 text-danger"></i>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Jumlah Soal</small>
                                            <small class="fw-bold">${mapel.jumlah_soal}</small>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Durasi</small>
                                            <small class="fw-bold">${mapel.durasi_ujian} menit</small>
                                        </div>
                                        ${scoreInfo}
                                    </div>
                                    
                                    <div class="mt-auto">
                                        ${button}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }, 1000);
            },
            
            loadDashboardStats: () => {
                // Update stats
                document.getElementById('statAgenda').textContent = '3';
                document.getElementById('statMapel').textContent = '4';
                document.getElementById('statSelesai').textContent = '1';
                document.getElementById('statProgress').textContent = '25%';
                
                // Start dashboard timer
                if (App.state.dashInterval) {
                    clearInterval(App.state.dashInterval);
                }
                
                // Update time every second
                App.state.dashInterval = setInterval(() => {
                    // Update any real-time stats here
                }, 1000);
            },
            
            viewAgendaDetails: (id) => {
                // Show agenda details
                Swal.fire({
                    title: 'Detail Agenda',
                    html: `
                        <div class="text-start">
                            <p><strong>Ujian Tengah Semester Genap 2024</strong></p>
                            <p><small class="text-muted">ðŸ“… Tanggal: 15 Juni 2024</small></p>
                            <p><small class="text-muted">â° Waktu: 08:00 - 12:00 WIB</small></p>
                            <p><small class="text-muted">ðŸ“ Lokasi: Online</small></p>
                            <p><small class="text-muted">ðŸ“ Mata Pelajaran: Matematika, Bahasa Indonesia, IPA, Bahasa Inggris</small></p>
                            <div class="alert alert-info mt-3">
                                <small><i class="bi bi-info-circle"></i> Persiapkan diri Anda dengan baik sebelum ujian dimulai</small>
                            </div>
                        </div>
                    `,
                    confirmButtonColor: '#dc2626'
                });
            }
        };

        // Exam Module
        const Exam = {
            confirm: (mapelId) => {
                App.state.tempMapelId = mapelId;
                
                // Reset agreement checkbox
                document.getElementById('checkAgree').checked = false;
                document.getElementById('btnStartReal').disabled = true;
                
                // Update exam info
                document.getElementById('examDurationInfo').textContent = '120 menit';
                document.getElementById('examQuestionCount').textContent = '40 soal';
                
                // Show rules modal
                const modal = new bootstrap.Modal(document.getElementById('modalRules'));
                modal.show();
                
                // Enable start button when agreed
                document.getElementById('checkAgree').onchange = (e) => {
                    document.getElementById('btnStartReal').disabled = !e.target.checked;
                };
            },
            
            startReal: () => {
                // Close rules modal
                bootstrap.Modal.getInstance(document.getElementById('modalRules')).hide();
                
                App.ui.showLoader(true, 'Menyiapkan soal ujian...');
                
                // Simulate loading exam data
                setTimeout(() => {
                    App.ui.showLoader(false);
                    
                    // Mock exam data
                    App.state.soal = generateMockSoal(40);
                    App.state.activeMapel = {
                        id: App.state.tempMapelId,
                        nama_mata_pelajaran: "Matematika",
                        durasi_ujian: 120
                    };
                    
                    // Initialize answers array
                    App.state.jawaban = Array(40).fill('-');
                    App.state.ragu = Array(40).fill(false);
                    
                    // Set end time (2 hours from now)
                    App.state.endTime = Date.now() + (120 * 60 * 1000);
                    
                    // Switch to exam view
                    App.ui.showView('viewUjian');
                    App.state.currentSoalIdx = 0;
                    
                    // Initialize exam
                    this.initializeExam();
                }, 2000);
            },
            
            continueExam: (mapelId) => {
                // Continue from saved progress
                App.state.tempMapelId = mapelId;
                this.startReal();
            },
            
            initializeExam: () => {
                // Update UI
                document.getElementById('ujianMapelName').textContent = 
                    App.state.activeMapel.nama_mata_pelajaran;
                
                document.getElementById('questionCounter').textContent = 
                    `${App.state.currentSoalIdx + 1}/${App.state.soal.length}`;
                
                // Start timer
                this.startTimer();
                
                // Start auto-save
                this.startAutoSave();
                
                // Initialize anti-cheat
                this.setupAntiCheat();
                
                // Render first question
                this.renderSoal();
                
                // Update navigation grid
                this.updateNavigation();
                
                // Update stats
                this.updateExamStats();
            },
            
            renderSoal: () => {
                const soal = App.state.soal[App.state.currentSoalIdx];
                const jawaban = App.state.jawaban[App.state.currentSoalIdx];
                const isRagu = App.state.ragu[App.state.currentSoalIdx];
                
                // Update current question indicator
                document.getElementById('questionCounter').textContent = 
                    `${App.state.currentSoalIdx + 1}/${App.state.soal.length}`;
                
                // Update ragu checkbox
                document.getElementById('checkRagu').checked = isRagu;
                
                // Build question HTML
                let html = `
                    <div class="question-header">
                        <div>
                            <span class="question-number">Soal No. ${App.state.currentSoalIdx + 1}</span>
                        </div>
                        <div>
                            <span class="question-type">${soal.type}</span>
                        </div>
                    </div>
                    
                    <div class="question-content">
                        ${soal.pertanyaan}
                    </div>
                `;
                
                // Add image if exists
                if (soal.gambar_url) {
                    html += `
                        <div class="text-center my-4">
                            <img src="${soal.gambar_url}" class="question-image" alt="Gambar soal">
                        </div>
                    `;
                }
                
                // Render based on question type
                if (soal.type.includes('Pilihan Ganda')) {
                    html += this.renderPilihanGanda(soal, jawaban);
                } else if (soal.type.includes('Essay')) {
                    html += this.renderEssay(soal, jawaban);
                } else if (soal.type.includes('Benar-Salah')) {
                    html += this.renderBenarSalah(soal, jawaban);
                } else if (soal.type.includes('Penjodohan')) {
                    html += this.renderPenjodohan(soal, jawaban);
                } else if (soal.type.includes('Checklist')) {
                    html += this.renderChecklist(soal, jawaban);
                }
                
                document.getElementById('soalContainer').innerHTML = html;
                
                // Update navigation buttons
                this.updateNavButtons();
            },
            
            renderPilihanGanda: (soal, jawaban) => {
                let html = '<div class="options-grid">';
                
                ['A', 'B', 'C', 'D', 'E'].forEach((option, index) => {
                    const optionText = soal[`pilihan_${option.toLowerCase()}`];
                    if (optionText) {
                        const isSelected = jawaban === option;
                        html += `
                            <div class="option-item ${isSelected ? 'selected' : ''}" 
                                 onclick="Exam.selectOption('${option}')">
                                <div class="option-label">${option}</div>
                                <div class="option-text">${optionText}</div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                return html;
            },
            
            renderEssay: (soal, jawaban) => {
                return `
                    <div class="mb-4">
                        <textarea class="essay-input" oninput="Exam.updateEssay(this.value)" 
                                  placeholder="Ketik jawaban Anda di sini...">${jawaban === '-' ? '' : jawaban}</textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Jawaban essay akan diperiksa oleh pengajar
                    </div>
                `;
            },
            
            renderBenarSalah: (soal, jawaban) => {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th width="60%">Pernyataan</th>
                                    <th class="text-center">Benar</th>
                                    <th class="text-center">Salah</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Parse jawaban
                const answers = jawaban === '-' ? [] : jawaban.split(',');
                
                for (let i = 1; i <= 5; i++) {
                    const pernyataan = soal[`pernyataan_${i}`];
                    if (pernyataan) {
                        const currentAnswer = answers[i - 1] || '';
                        html += `
                            <tr>
                                <td>${pernyataan}</td>
                                <td class="text-center">
                                    <input type="radio" name="bs_${i}" value="B" 
                                           ${currentAnswer === 'B' ? 'checked' : ''}
                                           onchange="Exam.updateBenarSalah(${i}, 'B')">
                                </td>
                                <td class="text-center">
                                    <input type="radio" name="bs_${i}" value="S" 
                                           ${currentAnswer === 'S' ? 'checked' : ''}
                                           onchange="Exam.updateBenarSalah(${i}, 'S')">
                                </td>
                            </tr>
                        `;
                    }
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                return html;
            },
            
            renderPenjodohan: (soal, jawaban) => {
                // Initialize connection interface
                App.state.selectedLeftIndex = null;
                
                let html = `
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Klik item di kolom kiri, kemudian klik item di kolom kanan untuk menjodohkan
                    </div>
                    
                    <div class="connection-container">
                        <div class="connection-column">
                            <h6>Pernyataan</h6>
                `;
                
                // Left column items
                for (let i = 1; i <= 5; i++) {
                    const item = soal[`pernyataan_kiri_${i}`];
                    if (item) {
                        html += `
                            <div class="connection-item left-item" data-index="${i}" 
                                 onclick="Exam.selectConnectionItem(${i}, 'left')">
                                <div class="connection-number">${i}</div>
                                <div class="connection-text">${item}</div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                        <div class="connection-column">
                            <h6>Jawaban</h6>
                `;
                
                // Right column items
                for (let i = 1; i <= 5; i++) {
                    const item = soal[`pernyataan_kanan_${i}`];
                    if (item) {
                        const letter = String.fromCharCode(64 + i);
                        html += `
                            <div class="connection-item right-item" data-letter="${letter}" 
                                 onclick="Exam.selectConnectionItem('${letter}', 'right')">
                                <div class="connection-number">${letter}</div>
                                <div class="connection-text">${item}</div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                    
                    <div class="connections-display mt-4">
                        <h6>Jodohan Anda:</h6>
                        <div id="connectionsList"></div>
                    </div>
                `;
                
                // Render existing connections
                this.renderConnections();
                
                return html;
            },
            
            renderChecklist: (soal, jawaban) => {
                let html = '<div class="options-grid">';
                const answers = jawaban === '-' ? [] : jawaban.split(',');
                
                ['A', 'B', 'C', 'D', 'E'].forEach((option, index) => {
                    const optionText = soal[`pilihan_${option.toLowerCase()}`];
                    if (optionText) {
                        const isChecked = answers.includes(option);
                        html += `
                            <div class="option-item ${isChecked ? 'selected' : ''}" 
                                 onclick="Exam.toggleChecklist('${option}')">
                                <div class="option-label">${option}</div>
                                <div class="option-text">${optionText}</div>
                                <div>
                                    ${isChecked ? '<i class="bi bi-check-square-fill text-danger"></i>' : '<i class="bi bi-square text-muted"></i>'}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                return html;
            },
            
            selectOption: (option) => {
                App.state.jawaban[App.state.currentSoalIdx] = option;
                this.updateQuestionStatus();
                this.renderSoal();
            },
            
            updateEssay: (value) => {
                App.state.jawaban[App.state.currentSoalIdx] = value || '-';
                this.updateQuestionStatus();
            },
            
            updateBenarSalah: (index, value) => {
                let answers = App.state.jawaban[App.state.currentSoalIdx];
                if (answers === '-') {
                    answers = Array(5).fill('').join(',');
                }
                
                const answerArray = answers.split(',');
                answerArray[index - 1] = value;
                App.state.jawaban[App.state.currentSoalIdx] = answerArray.join(',');
                this.updateQuestionStatus();
            },
            
            selectConnectionItem: (item, type) => {
                if (type === 'left') {
                    // Select left item
                    App.state.selectedLeftIndex = item;
                    
                    // Update UI
                    document.querySelectorAll('.left-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    document.querySelector(`.left-item[data-index="${item}"]`).classList.add('active');
                } else if (type === 'right' && App.state.selectedLeftIndex) {
                    // Make connection
                    const leftIndex = App.state.selectedLeftIndex;
                    const rightLetter = item;
                    
                    this.addConnection(leftIndex, rightLetter);
                    
                    // Clear selection
                    App.state.selectedLeftIndex = null;
                    document.querySelectorAll('.left-item').forEach(el => {
                        el.classList.remove('active');
                    });
                }
            },
            
            addConnection: (leftIndex, rightLetter) {
                let connections = App.state.jawaban[App.state.currentSoalIdx];
                if (connections === '-') {
                    connections = '';
                }
                
                // Remove existing connection for this left index
                const connectionArray = connections.split(',').filter(conn => {
                    return !conn.startsWith(leftIndex + ':');
                });
                
                // Add new connection
                connectionArray.push(`${leftIndex}:${rightLetter}`);
                
                // Sort connections
                connectionArray.sort((a, b) => {
                    return parseInt(a.split(':')[0]) - parseInt(b.split(':')[0]);
                });
                
                App.state.jawaban[App.state.currentSoalIdx] = connectionArray.join(',') || '-';
                
                this.updateQuestionStatus();
                this.renderConnections();
            },
            
            renderConnections: () => {
                const connections = App.state.jawaban[App.state.currentSoalIdx];
                const container = document.getElementById('connectionsList');
                
                if (!container) return;
                
                // Clear existing connections
                document.querySelectorAll('.connection-item').forEach(item => {
                    item.classList.remove('connected');
                });
                
                if (connections === '-') {
                    container.innerHTML = '<p class="text-muted">Belum ada jodohan</p>';
                    return;
                }
                
                container.innerHTML = '';
                const connectionArray = connections.split(',');
                
                connectionArray.forEach(conn => {
                    if (conn) {
                        const [leftIndex, rightLetter] = conn.split(':');
                        
                        // Highlight connected items
                        const leftItem = document.querySelector(`.left-item[data-index="${leftIndex}"]`);
                        const rightItem = document.querySelector(`.right-item[data-letter="${rightLetter}"]`);
                        
                        if (leftItem) leftItem.classList.add('connected');
                        if (rightItem) rightItem.classList.add('connected');
                        
                        // Add to display
                        container.innerHTML += `
                            <span class="connection-pair">
                                ${leftIndex} â†’ ${rightLetter}
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="Exam.removeConnection('${leftIndex}')">
                                    <i class="bi bi-x"></i>
                                </button>
                            </span>
                        `;
                    }
                });
            },
            
            removeConnection: (leftIndex) => {
                let connections = App.state.jawaban[App.state.currentSoalIdx];
                const connectionArray = connections.split(',').filter(conn => {
                    return !conn.startsWith(leftIndex + ':');
                });
                
                App.state.jawaban[App.state.currentSoalIdx] = connectionArray.join(',') || '-';
                
                this.updateQuestionStatus();
                this.renderConnections();
                this.renderSoal();
            },
            
            toggleChecklist: (option) => {
                let answers = App.state.jawaban[App.state.currentSoalIdx];
                if (answers === '-') {
                    answers = '';
                }
                
                const answerArray = answers.split(',');
                const index = answerArray.indexOf(option);
                
                if (index > -1) {
                    answerArray.splice(index, 1);
                } else {
                    answerArray.push(option);
                }
                
                App.state.jawaban[App.state.currentSoalIdx] = answerArray.join(',') || '-';
                this.updateQuestionStatus();
                this.renderSoal();
            },
            
            toggleRagu: () => {
                App.state.ragu[App.state.currentSoalIdx] = !App.state.ragu[App.state.currentSoalIdx];
                this.updateQuestionStatus();
            },
            
            updateQuestionStatus: () => {
                // Update stats
                this.updateExamStats();
                
                // Update navigation grid
                this.updateNavigation();
                
                // Auto-save
                this.autoSave();
            },
            
            updateExamStats: () => {
                const total = App.state.soal.length;
                let terjawab = 0;
                let diragukan = 0;
                let belumDijawab = 0;
                
                App.state.jawaban.forEach((jawab, index) => {
                    if (jawab !== '-') {
                        terjawab++;
                    } else {
                        belumDijawab++;
                    }
                    
                    if (App.state.ragu[index]) {
                        diragukan++;
                    }
                });
                
                App.state.examStats = {
                    totalSoal: total,
                    terjawab: terjawab,
                    diragukan: diragukan,
                    belumDijawab: belumDijawab
                };
                
                // Update finish modal stats
                document.getElementById('answeredCount').textContent = terjawab;
                document.getElementById('flaggedCount').textContent = diragukan;
                document.getElementById('unansweredCount').textContent = belumDijawab;
            },
            
            updateNavigation: () => {
                const grid1 = document.getElementById('navGridDesktop');
                const grid2 = document.getElementById('navGridDesktop2');
                
                if (!grid1 || !grid2) return;
                
                let html = '';
                
                App.state.soal.forEach((_, index) => {
                    const isCurrent = index === App.state.currentSoalIdx;
                    const isAnswered = App.state.jawaban[index] !== '-';
                    const isRagu = App.state.ragu[index];
                    
                    let className = 'nav-btn';
                    if (isCurrent) className += ' active';
                    if (isAnswered) className += ' answered';
                    if (isRagu) className += ' flagged';
                    
                    html += `
                        <button class="${className}" onclick="Exam.jumpToQuestion(${index})">
                            ${index + 1}
                        </button>
                    `;
                });
                
                grid1.innerHTML = html;
                grid2.innerHTML = html;
            },
            
            jumpToQuestion: (index) => {
                App.state.currentSoalIdx = index;
                this.renderSoal();
                this.updateNavButtons();
            },
            
            navSoal: (direction) => {
                const newIndex = App.state.currentSoalIdx + direction;
                
                if (newIndex >= 0 && newIndex < App.state.soal.length) {
                    App.state.currentSoalIdx = newIndex;
                    this.renderSoal();
                    this.updateNavButtons();
                }
            },
            
            updateNavButtons: () => {
                const isFirst = App.state.currentSoalIdx === 0;
                const isLast = App.state.currentSoalIdx === App.state.soal.length - 1;
                
                document.getElementById('btnPrev').disabled = isFirst;
                document.getElementById('btnNext').disabled = false;
                document.getElementById('btnPrevMobile').disabled = isFirst;
                document.getElementById('btnNextMobile').disabled = false;
                
                if (isLast) {
                    document.getElementById('btnNext').innerHTML = 'Selesai <i class="bi bi-flag"></i>';
                    document.getElementById('btnNext').onclick = () => this.showFinishModal();
                    document.getElementById('btnNextMobile').innerHTML = '<i class="bi bi-flag"></i>';
                    document.getElementById('btnNextMobile').onclick = () => this.showFinishModal();
                } else {
                    document.getElementById('btnNext').innerHTML = 'Selanjutnya <i class="bi bi-chevron-right"></i>';
                    document.getElementById('btnNext').onclick = () => this.navSoal(1);
                    document.getElementById('btnNextMobile').innerHTML = '<i class="bi bi-chevron-right"></i>';
                    document.getElementById('btnNextMobile').onclick = () => this.navSoal(1);
                }
            },
            
            startTimer: () => {
                if (App.state.timer) {
                    clearInterval(App.state.timer);
                }
                
                const updateTimer = () => {
                    const now = Date.now();
                    const remaining = App.state.endTime - now;
                    
                    if (remaining <= 0) {
                        clearInterval(App.state.timer);
                        this.finish(true); // Auto-finish when time's up
                        return;
                    }
                    
                    const hours = Math.floor(remaining / 3600000);
                    const minutes = Math.floor((remaining % 3600000) / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    
                    const timerDisplay = document.getElementById('timerDisplay');
                    timerDisplay.innerHTML = `
                        <i class="bi bi-clock"></i>
                        <span>${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
                    `;
                    
                    // Add warning class when less than 5 minutes
                    if (remaining < 300000) { // 5 minutes
                        timerDisplay.classList.add('warning');
                    }
                    
                    // Add danger class when less than 1 minute
                    if (remaining < 60000) {
                        timerDisplay.classList.add('danger');
                    }
                };
                
                updateTimer();
                App.state.timer = setInterval(updateTimer, 1000);
            },
            
            startAutoSave: () => {
                if (App.state.autoSaveInterval) {
                    clearInterval(App.state.autoSaveInterval);
                }
                
                App.state.autoSaveInterval = setInterval(() => {
                    this.autoSave();
                }, 30000); // Auto-save every 30 seconds
            },
            
            autoSave: () => {
                // Save to localStorage
                const examKey = `exam_${App.state.activeMapel.id}`;
                App.storage.save(examKey, {
                    jawaban: App.state.jawaban,
                    ragu: App.state.ragu,
                    currentSoalIdx: App.state.currentSoalIdx,
                    endTime: App.state.endTime,
                    lastSave: Date.now()
                });
                
                // Update save status
                const saveStatus = document.getElementById('saveStatus');
                if (saveStatus) {
                    saveStatus.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Tersimpan</small>';
                    setTimeout(() => {
                        saveStatus.innerHTML = '';
                    }, 3000);
                }
                
                App.state.lastSaveTime = Date.now();
            },
            
            saveProgress: () => {
                this.autoSave();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Progress Disimpan',
                    text: 'Jawaban Anda telah disimpan',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            
            setupAntiCheat: () => {
                let warningCount = 0;
                
                const handleVisibilityChange = () => {
                    if (document.hidden && !document.getElementById('viewUjian').classList.contains('d-none')) {
                        warningCount++;
                        
                        if (warningCount >= 3) {
                            // Too many violations, force finish
                            this.finish(true);
                            return;
                        }
                        
                        // Show violation modal
                        App.state.cheatTimer = 30;
                        document.getElementById('violationTimer').textContent = App.state.cheatTimer;
                        
                        const modal = new bootstrap.Modal(document.getElementById('modalViolation'));
                        modal.show();
                        
                        // Start countdown
                        if (App.state.cheatInterval) {
                            clearInterval(App.state.cheatInterval);
                        }
                        
                        App.state.cheatInterval = setInterval(() => {
                            App.state.cheatTimer--;
                            document.getElementById('violationTimer').textContent = App.state.cheatTimer;
                            
                            if (App.state.cheatTimer <= 0) {
                                clearInterval(App.state.cheatInterval);
                                document.getElementById('btnResumeExam').classList.add('d-none');
                                document.getElementById('btnForceFinish').classList.remove('d-none');
                            }
                        }, 1000);
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // Prevent context menu
                document.addEventListener('contextmenu', (e) => {
                    if (!document.getElementById('viewUjian').classList.contains('d-none')) {
                        e.preventDefault();
                    }
                });
                
                // Prevent keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (!document.getElementById('viewUjian').classList.contains('d-none')) {
                        // Prevent F5, Ctrl+R, Ctrl+Shift+R
                        if (e.key === 'F5' || 
                            (e.ctrlKey && e.key === 'r') || 
                            (e.ctrlKey && e.shiftKey && e.key === 'R')) {
                            e.preventDefault();
                        }
                        
                        // Prevent Ctrl+P
                        if (e.ctrlKey && e.key === 'p') {
                            e.preventDefault();
                        }
                    }
                });
            },
            
            resume: () => {
                // Resume exam after violation
                clearInterval(App.state.cheatInterval);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalViolation'));
                if (modal) {
                    modal.hide();
                }
                
                // Show warning
                App.ui.showNotification('Peringatan', 'Anda telah meninggalkan halaman ujian', 'warning');
            },
            
            showFinishModal: () => {
                const modal = new bootstrap.Modal(document.getElementById('modalFinish'));
                modal.show();
            },
            
            finish: (force = false) => {
                if (!force) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFinish'));
                    if (modal) {
                        modal.hide();
                    }
                }
                
                App.ui.showLoader(true, 'Menyimpan hasil ujian...');
                
                // Clear all intervals
                if (App.state.timer) clearInterval(App.state.timer);
                if (App.state.cheatInterval) clearInterval(App.state.cheatInterval);
                if (App.state.autoSaveInterval) clearInterval(App.state.autoSaveInterval);
                if (App.state.dashInterval) clearInterval(App.state.dashInterval);
                
                // Simulate saving to server
                setTimeout(() => {
                    App.ui.showLoader(false);
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Ujian Selesai!',
                        html: `
                            <div class="text-start">
                                <p>Hasil ujian telah disimpan</p>
                                <div class="alert alert-success">
                                    <small>
                                        <strong>Statistik Ujian:</strong><br>
                                        â€¢ Total soal: ${App.state.examStats.totalSoal}<br>
                                        â€¢ Terjawab: ${App.state.examStats.terjawab}<br>
                                        â€¢ Diragukan: ${App.state.examStats.diragukan}<br>
                                        â€¢ Belum dijawab: ${App.state.examStats.belumDijawab}
                                    </small>
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#10b981',
                        confirmButtonText: 'Kembali ke Dashboard'
                    }).then(() => {
                        // Clear exam data
                        App.storage.clearExamData();
                        
                        // Reset exam state
                        App.state.soal = [];
                        App.state.jawaban = [];
                        App.state.ragu = [];
                        App.state.activeMapel = null;
                        
                        // Show dashboard
                        Dashboard.show();
                    });
                }, 2000);
            }
        };

        // Helper Functions
        function updateUserAvatar() {
            if (!App.state.user || !App.state.user.nama_peserta) return;
            
            const initials = App.state.user.nama_peserta
                .split(' ')
                .map(name => name[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(el => {
                el.textContent = initials;
            });
        }
        
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        function showExamMenu() {
            document.getElementById('examMenu').style.transform = 'translateX(0)';
        }
        
        function hideExamMenu() {
            document.getElementById('examMenu').style.transform = 'translateX(-100%)';
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
        }
        
        function showResults() {
            document.getElementById('dashboardContent').querySelectorAll('div[id^="sec"]').forEach(sec => {
                sec.classList.add('d-none');
            });
            document.getElementById('secResults').classList.remove('d-none');
            
            // Load results
            loadExamResults();
        }
        
        function showProfile() {
            document.getElementById('dashboardContent').querySelectorAll('div[id^="sec"]').forEach(sec => {
                sec.classList.add('d-none');
            });
            document.getElementById('secProfile').classList.remove('d-none');
            
            // Load profile
            loadUserProfile();
        }
        
        function loadExamResults() {
            const container = document.getElementById('resultsContainer');
            
            // Mock results data
            const mockResults = [
                { mapel: 'Matematika', nilai: 85, tanggal: '2024-06-15', status: 'Selesai' },
                { mapel: 'Bahasa Indonesia', nilai: 78, tanggal: '2024-06-10', status: 'Selesai' },
                { mapel: 'IPA', nilai: 92, tanggal: '2024-06-05', status: 'Selesai' },
                { mapel: 'Bahasa Inggris', nilai: null, tanggal: null, status: 'Belum' }
            ];
            
            let html = `
                <div class="results-grid mb-4">
            `;
            
            mockResults.forEach(result => {
                html += `
                    <div class="result-card">
                        <h5>${result.mapel}</h5>
                        <div class="result-stats">
                            <div>
                                <div class="result-value">${result.nilai || '-'}</div>
                                <div class="result-label">Nilai</div>
                            </div>
                            <div class="text-end">
                                <div class="badge ${result.status === 'Selesai' ? 'bg-success' : 'bg-secondary'}">
                                    ${result.status}
                                </div>
                                ${result.tanggal ? `<div class="result-label mt-2">${result.tanggal}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="performance-chart">
                    <h5>ðŸ“ˆ Grafik Performa</h5>
                    <div id="performanceChart" style="height: 300px;"></div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Initialize chart
            initializePerformanceChart();
        }
        
        function initializePerformanceChart() {
            const options = {
                series: [{
                    name: 'Nilai',
                    data: [85, 78, 92]
                }],
                chart: {
                    type: 'line',
                    height: 300,
                    toolbar: { show: false }
                },
                colors: ['#dc2626'],
                stroke: {
                    width: 3,
                    curve: 'smooth'
                },
                markers: {
                    size: 5,
                    colors: ['#dc2626']
                },
                xaxis: {
                    categories: ['Matematika', 'Bahasa Indonesia', 'IPA']
                },
                yaxis: {
                    min: 0,
                    max: 100,
                    title: {
                        text: 'Nilai'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val + " poin"
                        }
                    }
                }
            };
            
            const chart = new ApexCharts(document.querySelector("#performanceChart"), options);
            chart.render();
        }
        
        function loadUserProfile() {
            const container = document.getElementById('profileContainer');
            
            if (!App.state.user) return;
            
            const user = App.state.user;
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="text-center mb-4">
                                <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 1.5rem;"></div>
                                <h5 class="fw-bold">${user.nama_peserta}</h5>
                                <p class="text-muted">Peserta Ujian</p>
                            </div>
                            
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Status</span>
                                    <span class="badge bg-success">Aktif</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Jenjang</span>
                                    <span class="fw-bold">${user.jenjang_studi || '-'}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Kelas</span>
                                    <span class="fw-bold">${user.kelas || '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="dashboard-card">
                            <h5 class="fw-bold mb-4">Informasi Akun</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nama Lengkap</label>
                                    <input type="text" class="form-control" value="${user.nama_peserta}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" value="${user.nis_username}" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Asal Sekolah</label>
                                    <input type="text" class="form-control" value="${user.asal_sekolah}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">No. WhatsApp</label>
                                    <input type="text" class="form-control" value="${user.no_wa_peserta}" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">No. WhatsApp Ortu</label>
                                    <input type="text" class="form-control" value="${user.no_wa_ortu}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Agenda Terdaftar</label>
                                    <input type="text" class="form-control" value="Ujian Tengah Semester" readonly>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-outline-danger" onclick="editProfile()">
                                    <i class="bi bi-pencil me-2"></i> Edit Profile
                                </button>
                                <button class="btn btn-danger ms-2" onclick="changePassword()">
                                    <i class="bi bi-key me-2"></i> Ganti Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update avatar in profile
            updateUserAvatar();
        }
        
        function editProfile() {
            // Show profile edit modal
            Swal.fire({
                title: 'Edit Profile',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" id="editNama" class="form-control" value="${App.state.user.nama_peserta}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">No. WhatsApp</label>
                            <input type="tel" id="editWa" class="form-control" value="${App.state.user.no_wa_peserta}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">No. WhatsApp Ortu</label>
                            <input type="tel" id="editWaOrtu" class="form-control" value="${App.state.user.no_wa_ortu}">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Simpan Perubahan',
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const nama = document.getElementById('editNama').value;
                    const wa = document.getElementById('editWa').value;
                    const waOrtu = document.getElementById('editWaOrtu').value;
                    
                    if (!nama || !wa || !waOrtu) {
                        Swal.showValidationMessage('Harap lengkapi semua field');
                        return false;
                    }
                    
                    return { nama, wa, waOrtu };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Update user data
                    App.state.user.nama_peserta = result.value.nama;
                    App.state.user.no_wa_peserta = result.value.wa;
                    App.state.user.no_wa_ortu = result.value.waOrtu;
                    
                    // Save to storage
                    App.storage.save('cbt_user', App.state.user);
                    
                    // Update UI
                    updateUserAvatar();
                    loadUserProfile();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Profile Diperbarui',
                        text: 'Perubahan profile telah disimpan',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }
        
        function changePassword() {
            Swal.fire({
                title: 'Ganti Password',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Password Lama</label>
                            <input type="password" id="oldPassword" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password Baru</label>
                            <input type="password" id="newPassword" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" id="confirmPassword" class="form-control">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ganti Password',
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const oldPass = document.getElementById('oldPassword').value;
                    const newPass = document.getElementById('newPassword').value;
                    const confirmPass = document.getElementById('confirmPassword').value;
                    
                    if (!oldPass || !newPass || !confirmPass) {
                        Swal.showValidationMessage('Harap lengkapi semua field');
                        return false;
                    }
                    
                    if (newPass !== confirmPass) {
                        Swal.showValidationMessage('Password baru tidak cocok');
                        return false;
                    }
                    
                    if (newPass.length < 6) {
                        Swal.showValidationMessage('Password minimal 6 karakter');
                        return false;
                    }
                    
                    return { oldPass, newPass };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Here you would make an API call to change password
                    Swal.fire({
                        icon: 'success',
                        title: 'Password Diubah',
                        text: 'Password Anda telah berhasil diubah',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }
        
        function downloadKartu() {
            const kartu = document.getElementById('kartuArea');
            
            html2canvas(kartu).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Kartu-Peserta-CBT-PRO.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Download Berhasil',
                    text: 'Kartu peserta telah diunduh',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }
        
        function tutupKartuKeLogin() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalKartu'));
            if (modal) {
                modal.hide();
            }
            
            // Switch to login tab
            document.querySelector('[data-bs-target="#tabLogin"]').click();
        }
        
        function refreshDashboard() {
            Dashboard.show();
            App.ui.showNotification('Dashboard', 'Data telah diperbarui', 'success');
        }
        
        function refreshMapel() {
            Dashboard.refreshMapel();
        }
        
        function filterAgenda(filter) {
            // Implement agenda filtering
            App.ui.showNotification('Filter', `Menampilkan agenda: ${filter}`, 'info');
        }
        
        function viewExamResult(mapelId) {
            Swal.fire({
                title: 'Hasil Ujian',
                html: `
                    <div class="text-start">
                        <div class="alert alert-success">
                            <h5 class="fw-bold">Nilai: 85</h5>
                            <p class="mb-0">Status: Lulus</p>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Detail Jawaban:</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="fw-bold text-success">35</h3>
                                            <small>Benar</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="fw-bold text-danger">5</h3>
                                            <small>Salah</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#dc2626'
            });
        }
        
        function showMaterials() {
            Swal.fire({
                title: 'Materi Pembelajaran',
                html: `
                    <div class="text-start">
                        <p>Materi akan tersedia setelah ujian selesai.</p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Fitur ini sedang dalam pengembangan
                        </div>
                    </div>
                `,
                confirmButtonColor: '#dc2626'
            });
        }
        
        function showSettings() {
            Swal.fire({
                title: 'Pengaturan',
                html: `
                    <div class="text-start">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notifSwitch">
                            <label class="form-check-label" for="notifSwitch">Notifikasi</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="soundSwitch" checked>
                            <label class="form-check-label" for="soundSwitch">Suara</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="autoSaveSwitch" checked>
                            <label class="form-check-label" for="autoSaveSwitch">Auto-save</label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Simpan',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Pengaturan Disimpan',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }
        
        // Mock API functions (replace with actual Google Apps Script calls)
        async function mockLogin(username, password) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Mock response
            return {
                success: true,
                data: {
                    id: 1,
                    nama_peserta: "John Doe",
                    nis_username: username,
                    jenjang_studi: "SMA",
                    kelas: "X IPA 1",
                    asal_sekolah: "SMA Negeri 1 Jakarta",
                    no_wa_peserta: "081234567890",
                    no_wa_ortu: "081298765432",
                    id_agenda: 1,
                    status: "Aktif"
                }
            };
        }
        
        async function mockRegister(formData) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Mock response
            return {
                success: true,
                data: {
                    id: 2,
                    ...formData
                },
                nama_agenda: "Ujian Tengah Semester Genap 2024"
            };
        }
        
        function generateMockSoal(count) {
            const soalTypes = [
                'Pilihan Ganda',
                'Essay',
                'Benar-Salah',
                'Penjodohan',
                'Checklist'
            ];
            
            const soalList = [];
            
            for (let i = 1; i <= count; i++) {
                const type = soalTypes[Math.floor(Math.random() * soalTypes.length)];
                
                let soal = {
                    id: i,
                    pertanyaan: `Soal nomor ${i}. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua?`,
                    type: type,
                    gambar_url: i % 5 === 0 ? 'https://source.unsplash.com/random/600x400/?education' : null
                };
                
                // Add options based on type
                if (type === 'Pilihan Ganda' || type === 'Checklist') {
                    soal.pilihan_a = "Pilihan A: " + "Lorem ipsum dolor sit amet";
                    soal.pilihan_b = "Pilihan B: " + "Consectetur adipiscing elit";
                    soal.pilihan_c = "Pilihan C: " + "Sed do eiusmod tempor";
                    soal.pilihan_d = "Pilihan D: " + "Incididunt ut labore";
                    soal.pilihan_e = "Pilihan E: " + "Dolore magna aliqua";
                } else if (type === 'Benar-Salah') {
                    for (let j = 1; j <= 5; j++) {
                        soal[`pernyataan_${j}`] = `Pernyataan ${j}: Lorem ipsum dolor sit amet`;
                    }
                } else if (type === 'Penjodohan') {
                    for (let j = 1; j <= 5; j++) {
                        soal[`pernyataan_kiri_${j}`] = `Pernyataan kiri ${j}`;
                        soal[`pernyataan_kanan_${j}`] = `Pernyataan kanan ${String.fromCharCode(64 + j)}`;
                    }
                }
                
                soalList.push(soal);
            }
            
            return soalList;
        }
        
        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            Auth.init();
        });
        
        // Global exports
        window.Auth = Auth;
        window.Dashboard = Dashboard;
        window.Exam = Exam;
        window.loadAgendaDropdown = () => {
            // Mock loading agendas for registration
            const select = document.getElementById('regAgenda');
            if (select.options.length <= 1) {
                select.innerHTML = `
                    <option value="">Pilih Agenda Ujian</option>
                    <option value="1">Ujian Tengah Semester Genap 2024</option>
                    <option value="2">Ujian Harian Matematika</option>
                    <option value="3">Try Out UNBK 2024</option>
                `;
            }
        };
    </script>
</body>
</html>
