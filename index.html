<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT PRO - Ujian Online</title>
    <!-- Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --primary-red: #dc2626;
            --primary-red-hover: #b91c1c;
            --white: #ffffff;
            --light-bg: #f9fafb;
            --dark-text: #111827;
            --muted-text: #6b7280;
            --border-color: #e5e7eb;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --info-blue: #3b82f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            user-select: none;
            overflow-x: hidden;
        }

        /* AUTH & DASHBOARD */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-red) 0%, #991b1b 100%);
            padding: 20px;
        }
        .auth-card {
            background: var(--white);
            width: 100%;
            max-width: 900px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .agenda-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: var(--white);
        }
        .agenda-card:hover {
            transform: translateY(-6px);
            border-color: var(--primary-red);
            box-shadow: 0 20px 25px -5px rgba(220, 38, 38, 0.15);
        }
        .btn-primary-custom {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: var(--white);
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border-radius: 12px;
        }
        .btn-primary-custom:hover {
            background-color: var(--primary-red-hover);
            border-color: var(--primary-red-hover);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        /* UJIAN LAYOUT */
        .ujian-navbar {
            height: 70px;
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .timer-badge {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            background: var(--light-bg);
            color: var(--primary-red);
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            letter-spacing: 0.05em;
        }
        .timer-warning {
            background: #fef2f2;
            color: var(--primary-red);
            border-color: var(--primary-red);
            animation: pulse 1.5s infinite;
        }
        .ujian-layout { margin-top: 90px; padding-bottom: 80px; }
        .soal-card {
            background: var(--white);
            padding: 32px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            min-height: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* SOAL ITEMS */
        .option-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-item:hover {
            background: var(--light-bg);
            border-color: var(--muted-text);
        }
        .option-item.selected {
            background: #fee2e2;
            border-color: var(--primary-red);
            color: #7f1d1d;
        }
        .option-label {
            width: 40px;
            height: 40px;
            background: var(--muted-text);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 16px;
            flex-shrink: 0;
        }
        .option-item.selected .option-label { background: var(--primary-red); }

        /* NAVIGASI */
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .nav-item-btn {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid var(--border-color);
            background: var(--white);
            border-radius: 8px;
            font-weight: 600;
            color: var(--muted-text);
            transition: all 0.2s;
        }
        .nav-item-btn:hover { border-color: var(--primary-red); color: var(--primary-red); }
        .nav-item-btn.active { border: 2px solid var(--primary-red); color: var(--primary-red); background: #fee2e2; }
        .nav-item-btn.filled { background: var(--primary-red); color: var(--white); border-color: var(--primary-red); }
        .nav-item-btn.ragu { background: var(--warning-orange); color: var(--white); border-color: var(--warning-orange); }
        .ujian-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1020;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* LOADER & ANIMATION */
        .loader-overlay {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(255,255,255,0.97);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .custom-loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-bottom-color: var(--primary-red);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* Password Toggle */
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--muted-text);
            cursor: pointer;
            z-index: 10;
        }
        .form-floating > .form-control {
            padding-right: 3.5rem;
        }
        .table th { font-weight: 600; }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 0.2rem rgba(220, 38, 38, 0.25);
        }

        /* --- STYLING UNTUK TABEL KONEKSI PENJODOHAN --- */
        .connection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .connection-column {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        .connection-column h6 {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--dark-text);
        }
        .connection-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            margin-bottom: 10px;
            background-color: var(--light-bg);
        }
        .connection-item:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
        }
        .connection-item.active-left {
            border-color: var(--primary-red);
            background-color: #fee2e2;
            color: #7f1d1d;
            font-weight: 600;
        }
        .connection-item.connected {
            border-color: var(--success-green);
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        .connection-display {
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        .connection-display h6 {
            font-weight: 600;
            margin-bottom: 12px;
        }
        .connection-list-item {
            display: inline-block;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 14px;
            margin: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- LOADER -->
    <div id="loader" class="loader-overlay d-none">
        <div class="custom-loader mb-3"></div>
        <h6 class="fw-bold text-secondary" id="loaderText">Memuat Sistem...</h6>
    </div>

    <!-- AUTH SCREEN -->
    <div id="viewAuth" class="auth-container">
        <div class="auth-card row g-0 animate__animated animate__fadeIn">
            <div class="col-lg-5 d-none d-lg-block" style="background: url('https://source.unsplash.com/random/800x1000/?education,abstract') center/cover;"></div>
            <div class="col-lg-7 p-5 p-lg-5">
                <h1 class="fw-bold text-white mb-2 text-center">CBT PRO</h1>
                <p class="text-center text-white-50 mb-5">Sistem Ujian Online Terintegrasi</p>
                <ul class="nav nav-pills nav-fill mb-4 bg-white bg-opacity-10 rounded-pill p-1" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link w-100 rounded-pill active fw-bold text-white" data-bs-toggle="pill" data-bs-target="#tabLogin" type="button">Masuk</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link w-100 rounded-pill fw-bold text-white" data-bs-toggle="pill" data-bs-target="#tabRegister" type="button" onclick="loadAgendaDropdown()">Daftar</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tabLogin">
                        <form onsubmit="Auth.login(event)">
                            <div class="form-floating mb-3 position-relative">
                                <input type="text" class="form-control rounded-3" id="loginUser" placeholder="User" required>
                                <label for="loginUser">Username / No WA</label>
                            </div>
                            <div class="form-floating mb-4 position-relative">
                                <input type="password" class="form-control rounded-3" id="loginPass" placeholder="Pass" required>
                                <label for="loginPass">Password</label>
                                <button type="button" class="password-toggle" onclick="Ui.togglePassword('loginPass', this)">
                                    <i class="bi bi-eye-slash-fill fs-5"></i>
                                </button>
                            </div>
                            <button class="btn btn-light w-100 py-3 rounded-3 fw-bold shadow-sm text-danger" type="submit">MASUK SEKARANG</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="tabRegister">
                        <form onsubmit="Auth.register(event)">
                            <select id="regAgenda" class="form-select py-3 rounded-3 mb-3" required><option value="">Memuat Agenda...</option></select>
                            <div class="row g-2 mb-3">
                                <div class="col-12"><input type="text" id="regNama" class="form-control py-3 rounded-3" placeholder="Nama Lengkap" required></div>
                                <div class="col-6"><select id="regJenjang" class="form-select py-3 rounded-3" required><option value="">Jenjang</option><option value="SD">SD</option><option value="SMP">SMP</option><option value="SMA">SMA</option></select></div>
                                <div class="col-6"><input type="text" id="regKelas" class="form-control py-3 rounded-3" placeholder="Kelas" required></div>
                            </div>
                            <input type="text" id="regSekolah" class="form-control py-3 rounded-3 mb-3" placeholder="Asal Sekolah" required>
                            <input type="number" id="regWa" class="form-control py-3 rounded-3 mb-3" placeholder="No WA (Jadi Username)" oninput="this.value=this.value.replace(/\D/g,'').replace(/^0|^62/,'')" required>
                            <input type="number" id="regWaOrtu" class="form-control py-3 rounded-3 mb-3" placeholder="No WA Ortu" required>
                            <div class="form-floating mb-3 position-relative">
                                <input type="password" class="form-control rounded-3" id="regPass" placeholder="Password" required>
                                <label for="regPass">Password</label>
                                <button type="button" class="password-toggle" onclick="Ui.togglePassword('regPass', this)">
                                    <i class="bi bi-eye-slash-fill fs-5"></i>
                                </button>
                            </div>
                            <button class="btn btn-success w-100 py-3 rounded-3 fw-bold" type="submit">DAFTAR AKUN</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="viewDashboard" class="d-none animate__animated animate__fadeIn">
        <div class="bg-white border-bottom py-3 sticky-top shadow-sm z-3">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px;height:40px"><i class="bi bi-person-fill"></i></div>
                    <div style="line-height:1.2"><h6 class="mb-0 fw-bold" id="dashNama">Peserta</h6><small class="text-muted" id="dashSekolah">Sekolah</small></div>
                </div>
                <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="Auth.logout()">Keluar</button>
            </div>
        </div>
        <div class="container py-4">
            <!-- SECTION 1: AGENDA LIST -->
            <div id="secAgenda">
                <h4 class="fw-bold mb-4">Agenda Tersedia</h4>
                <div id="agendaListContainer" class="row g-3"></div>
            </div>

            <!-- SECTION 2: TOKEN INPUT -->
            <div id="secToken" class="d-none animate__animated animate__fadeInRight">
                <button class="btn btn-sm btn-light mb-3" onclick="Dashboard.backToAgenda()"><i class="bi bi-arrow-left"></i> Kembali</button>
                <div class="card border-0 shadow-lg rounded-4 p-5 text-center mx-auto" style="max-width: 500px;">
                    <h4 class="fw-bold text-danger mb-1" id="tokenAgendaName">Ujian</h4>
                    <p class="text-muted mb-4">Masukkan Token Ujian</p>
                    <input type="text" id="inputToken" class="form-control form-control-lg text-center fw-bold fs-1 mb-4 rounded-3 text-uppercase" maxlength="5" placeholder="_ _ _ _ _" style="letter-spacing: 5px;">
                    <button class="btn btn-danger w-100 py-3 rounded-3 fw-bold" onclick="Dashboard.verifyToken()">VERIFIKASI TOKEN</button>
                </div>
            </div>

            <!-- SECTION 3: MAPEL LIST -->
            <div id="secMapel" class="d-none animate__animated animate__fadeInUp">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">Daftar Mata Pelajaran</h4>
                    <button class="btn btn-sm btn-light border" onclick="Dashboard.backToAgenda()">Ganti Agenda</button>
                </div>
                <div id="mapelListContainer" class="row g-3"></div>
            </div>
        </div>
    </div>

    <!-- UJIAN ENGINE -->
    <div id="viewUjian" class="d-none bg-light min-vh-100">
        <div class="ujian-navbar shadow-sm">
            <div><h6 class="mb-0 fw-bold" id="ujianMapelName">Mapel</h6><small class="text-muted d-none d-md-block">Dilarang Refresh Halaman!</small></div>
            <div id="timerDisplay" class="timer-badge">00:00:00</div>
        </div>
        <div class="container ujian-layout">
            <div class="row">
                <div class="col-lg-9">
                    <div id="soalContainer" class="soal-card shadow-lg animate__animated animate__fadeIn"></div>
                </div>
                <div class="col-lg-3 d-none d-lg-block">
                    <div class="card border-0 shadow-lg rounded-4 sticky-top" style="top: 90px;">
                        <div class="card-header bg-white border-0 pt-3"><h6 class="fw-bold">Navigasi Soal</h6></div>
                        <div class="card-body">
                            <div id="navGridDesktop" class="nav-grid"></div>
                            <button class="btn btn-danger w-100 mt-4 rounded-3 fw-bold" onclick="Exam.finish(false)">SELESAIKAN UJIAN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ujian-footer">
            <button class="btn btn-outline-secondary rounded-pill fw-bold px-4" id="btnPrev" onclick="Exam.navSoal(-1)">Sebelumnya</button>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="checkRagu" onchange="Exam.toggleRagu()"><label class="form-check-label fw-bold text-warning">Ragu</label></div>
            <button class="btn btn-danger rounded-pill fw-bold px-4" id="btnNext" onclick="Exam.navSoal(1)">Selanjutnya</button>
        </div>
    </div>

    <!-- MODAL RULES -->
    <div class="modal fade" id="modalRules" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header bg-danger text-white rounded-top-4"><h5 class="modal-title fw-bold">Tata Tertib Ujian</h5></div>
                <div class="modal-body p-4">
                    <div class="alert alert-warning d-flex align-items-center" role="alert"><i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i><div><strong>Perhatian!</strong> Waktu berjalan saat tombol mulai ditekan.</div></div>
                    <ol class="list-group list-group-numbered list-group-flush mb-3">
                        <li class="list-group-item">Dilarang membuka tab lain atau aplikasi lain.</li>
                        <li class="list-group-item">Sistem mendeteksi jika Anda keluar (Anti-Cheat).</li>
                        <li class="list-group-item">Jika terdeteksi keluar, hitungan mundur 30 detik akan dimulai untuk auto-submit.</li>
                    </ol>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="checkAgree">
                        <label class="form-check-label fw-bold" for="checkAgree">Saya mengerti dan siap mengerjakan dengan jujur.</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" id="btnStartReal" disabled onclick="Exam.startReal()">MULAI MENGERJAKAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VIOLATION (ANTI CHEAT) -->
    <div class="modal fade" id="modalViolation" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <div class="text-danger mb-3"><i class="bi bi-exclamation-octagon-fill display-1"></i></div>
                    <h3 class="fw-bold text-danger">PERINGATAN!</h3>
                    <p class="mb-4">Anda meninggalkan halaman ujian.<br>Ujian akan otomatis diselesaikan dalam:</p>
                    <h1 class="fw-bold mb-4 display-3" id="violationTimer">30</h1>
                    <button id="btnResumeExam" class="btn btn-outline-dark rounded-pill px-5 fw-bold" onclick="Exam.resume()">LANJUTKAN UJIAN</button>
                    <button id="btnForceFinish" class="btn btn-danger rounded-pill px-5 fw-bold d-none">SELESAIKAN SEKARANG</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL KARTU -->
    <div class="modal fade" id="modalKartu"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4"><div class="modal-body text-center p-4"><h5 class="fw-bold text-success mb-3">Registrasi Berhasil!</h5><div id="kartuArea" class="border p-3 text-start bg-white mb-3 rounded-3"><h6 class="text-center fw-bold border-bottom pb-2">KARTU PESERTA</h6><table class="table table-sm table-borderless mb-0"><tr><td>Nama</td><td class="fw-bold" id="cardNama"></td></tr><tr><td>User</td><td class="fw-bold text-danger" id="cardUser"></td></tr><tr><td>Pass</td><td class="fw-bold" id="cardPass"></td></tr><tr><td>Agenda</td><td id="cardAgenda"></td></tr></table></div><button class="btn btn-danger w-100 mb-2" onclick="downloadKartu()">Download</button><button class="btn btn-light w-100" onclick="tutupKartuKeLogin()">Login</button></div></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        async function apiFetch(path, { method = 'GET', body, query } = {}) {
            let url = path;
            if (query) {
                const qs = new URLSearchParams(query).toString();
                url += `?${qs}`;
            }

            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : undefined
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
            return data;
        }

        // GLOBAL STATE
        const App = {
            state: {
                user: null,
                agendaId: null,
                mapelList: [],
                activeMapel: null,
                tempMapelId: null,
                soal: [],
                jawaban: [],
                ragu: [],
                endTime: 0,
                timer: null,
                currentSoalIdx: 0,
                dashInterval: null,
                cheatTimer: 30,
                cheatInterval: null,
                selectedLeftIndex: null,
                antiCheatInstalled: false,
                saveDebounce: null
            },
            ui: {
                load: (s, t='Memuat...') => {
                    document.getElementById('loaderText').innerText = t;
                    document.getElementById('loader').classList.toggle('d-none', !s);
                },
                view: (id) => {
                    ['viewAuth','viewDashboard','viewUjian'].forEach(v => document.getElementById(v).classList.add('d-none'));
                    document.getElementById(id).classList.remove('d-none');
                }
            },
            data: {
                save:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
                get:(k)=>JSON.parse(localStorage.getItem(k)),
                remove:(k)=>localStorage.removeItem(k)
            }
        };

        // MODULE: UI HELPERS
        const Ui = {
            togglePassword: (inputId, button) => {
                const input = document.getElementById(inputId);
                const icon = button.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye-slash-fill');
                    icon.classList.add('bi-eye-fill');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-fill');
                    icon.classList.add('bi-eye-slash-fill');
                }
            }
        };

        // MODULE: AUTH
        const Auth = {
            init: () => {
                const u = App.data.get('cbt_user');
                if (u) {
                    App.state.user = u;
                    Dashboard.show();
                } else {
                    App.ui.view('viewAuth');
                }
            },

            login: async (e) => {
                e.preventDefault();
                App.ui.load(true,'Login...');
                try {
                    const r = await apiFetch('/api/login', {
                        method: 'POST',
                        body: {
                            u: document.getElementById('loginUser').value,
                            p: document.getElementById('loginPass').value
                        }
                    });
                    App.ui.load(false);

                    if (r.success) {
                        App.state.user = r.data;
                        App.data.save('cbt_user', r.data);
                        Dashboard.show();
                    } else {
                        Swal.fire({icon:'error', title:'Gagal', text: r.message, confirmButtonColor: '#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor: '#dc2626'});
                }
            },

            register: async (e) => {
                e.preventDefault();
                App.ui.load(true,'Daftar...');

                const f = {
                    agenda_id: document.getElementById('regAgenda').value,
                    nama: document.getElementById('regNama').value,
                    jenjang: document.getElementById('regJenjang').value,
                    kelas: document.getElementById('regKelas').value,
                    sekolah: document.getElementById('regSekolah').value,
                    no_wa: document.getElementById('regWa').value,
                    wa_ortu: document.getElementById('regWaOrtu').value,
                    password: document.getElementById('regPass').value,
                    username: document.getElementById('regWa').value.replace(/\D/g,'').replace(/^0|^62/,'')
                };

                try {
                    const r = await apiFetch('/api/register', { method: 'POST', body: f });
                    App.ui.load(false);

                    if (r.success) {
                        document.getElementById('cardNama').innerText = f.nama;
                        document.getElementById('cardUser').innerText = f.username;
                        document.getElementById('cardPass').innerText = f.password;
                        document.getElementById('cardAgenda').innerText = r.nama_agenda || '-';
                        new bootstrap.Modal(document.getElementById('modalKartu')).show();
                        e.target.reset();
                    } else {
                        Swal.fire({icon:'error', title:'Error', text: r.message, confirmButtonColor: '#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor: '#dc2626'});
                }
            },

            loadAgendas: async () => {
                const s = document.getElementById('regAgenda');
                if (s.options.length > 1) return;

                try {
                    const r = await apiFetch('/api/agenda');
                    s.innerHTML = '<option value="">Pilih Agenda</option>';
                    (r.data || []).forEach(a => {
                        s.innerHTML += `<option value="${a.id}">${a.agenda_ujian}</option>`;
                    });
                } catch (err) {
                    s.innerHTML = '<option value="">Gagal memuat agenda</option>';
                }
            },

            logout: () => {
                Swal.fire({
                    icon:'question',
                    title:'Keluar?',
                    text:'Apakah Anda yakin ingin keluar?',
                    showCancelButton:true,
                    confirmButtonColor:'#dc2626',
                    cancelButtonColor:'#6b7280',
                    confirmButtonText:'Ya, Keluar'
                }).then((result)=>{
                    if(result.isConfirmed){
                        App.data.remove('cbt_user');
                        if (App.state.dashInterval) clearInterval(App.state.dashInterval);
                        if (App.state.timer) clearInterval(App.state.timer);
                        if (App.state.cheatInterval) clearInterval(App.state.cheatInterval);
                        if (App.state.saveDebounce) clearTimeout(App.state.saveDebounce);

                        App.state = {
                            user: null, agendaId: null, mapelList: [], activeMapel: null, tempMapelId: null,
                            soal: [], jawaban: [], ragu: [], endTime: 0, timer: null, currentSoalIdx: 0,
                            dashInterval: null, cheatTimer: 30, cheatInterval: null, selectedLeftIndex: null,
                            antiCheatInstalled: false, saveDebounce: null
                        };

                        document.getElementById('loginUser').value = '';
                        document.getElementById('loginPass').value = '';
                        App.ui.view('viewAuth');
                    }
                });
            }
        };

        // MODULE: DASHBOARD
        const Dashboard = {
            show: async () => {
                App.ui.view('viewDashboard');
                document.getElementById('dashNama').innerText = App.state.user.nama_peserta;
                document.getElementById('dashSekolah').innerText = App.state.user.asal_sekolah;

                document.getElementById('secAgenda').classList.remove('d-none');
                document.getElementById('secToken').classList.add('d-none');
                document.getElementById('secMapel').classList.add('d-none');

                const cont = document.getElementById('agendaListContainer');
                cont.innerHTML = '<div class="spinner-border text-danger"></div>';

                try {
                    const res = await apiFetch('/api/agenda');
                    cont.innerHTML = '';

                    if(res.success && (res.data || []).length > 0) {
                        if(App.state.dashInterval) clearInterval(App.state.dashInterval);

                        res.data.forEach(a => {
                            cont.innerHTML += `
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 agenda-card p-4">
                                    <h5 class="fw-bold">${a.agenda_ujian}</h5>
                                    <div class="text-muted small mb-3">Mulai: ${new Date(a.tgljam_mulai).toLocaleString()}</div>
                                    <div id="count-${a.id}" class="alert alert-light border text-center fw-bold mb-3">...</div>
                                    <button id="btn-${a.id}" class="btn btn-primary-custom w-100 rounded-3 py-2" onclick="Dashboard.openToken(${a.id}, '${a.agenda_ujian}')">BUKA UJIAN</button>
                                </div>
                            </div>`;
                        });

                        const update = () => {
                            const now = new Date().getTime();
                            res.data.forEach(a => {
                                const start = new Date(a.tgljam_mulai).getTime();
                                const end = new Date(a.tgljam_selesai).getTime();
                                const elC = document.getElementById(`count-${a.id}`);
                                const elB = document.getElementById(`btn-${a.id}`);
                                if(!elC) return;

                                if(now < start) {
                                    elC.innerText = 'Dimulai dlm: ' + Dashboard.fmt(start - now);
                                    elC.className = 'alert alert-warning border text-center fw-bold mb-3';
                                    elB.disabled = true;
                                    elB.className = 'btn btn-secondary w-100 rounded-3 py-2';
                                } else if(now >= start && now <= end) {
                                    elC.innerText = 'Sisa Waktu: ' + Dashboard.fmt(end - now);
                                    elC.className = 'alert alert-success border text-center fw-bold mb-3';
                                    elB.disabled = false;
                                    elB.className = 'btn btn-primary-custom w-100 rounded-3 py-2';
                                } else {
                                    elC.innerText = 'BERAKHIR';
                                    elC.className = 'alert alert-danger border text-center fw-bold mb-3';
                                    elB.disabled = true;
                                    elB.className = 'btn btn-secondary w-100 rounded-3 py-2';
                                }
                            });
                        };

                        update();
                        App.state.dashInterval = setInterval(update, 1000);
                    } else {
                        cont.innerHTML = '<div class="col-12 text-center text-muted">Tidak ada agenda aktif.</div>';
                    }
                } catch (err) {
                    cont.innerHTML = `<div class="col-12 text-center text-danger">Gagal load agenda: ${err.message}</div>`;
                }
            },

            fmt: (ms) => {
                const d=Math.floor(ms/86400000),
                      h=Math.floor((ms%86400000)/3600000),
                      m=Math.floor((ms%3600000)/60000),
                      s=Math.floor((ms%60000)/1000);
                return (d>0?d+'h ':'') + h + 'j ' + m + 'm ' + s + 'd';
            },

            openToken: (id, name) => {
                App.state.agendaId = id;
                document.getElementById('secAgenda').classList.add('d-none');
                document.getElementById('secToken').classList.remove('d-none');
                document.getElementById('tokenAgendaName').innerText = name;
                document.getElementById('inputToken').value='';
            },

            backToAgenda: () => {
                document.getElementById('secToken').classList.add('d-none');
                document.getElementById('secMapel').classList.add('d-none');
                document.getElementById('secAgenda').classList.remove('d-none');
            },

            verifyToken: async () => {
                const t = document.getElementById('inputToken').value.trim();
                if(!t) return;

                App.ui.load(true,'Verifikasi Token...');
                try {
                    const r = await apiFetch('/api/verify-token', {
                        method: 'POST',
                        body: { agenda_id: App.state.agendaId, token: t }
                    });
                    if (r.success) {
                        await Dashboard.refreshMapel();
                    } else {
                        App.ui.load(false);
                        Swal.fire({icon:'error', title:'Gagal', text: r.message, confirmButtonColor: '#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor: '#dc2626'});
                }
            },

            refreshMapel: async () => {
                try {
                    const r = await apiFetch('/api/mapel', {
                        query: { agenda_id: App.state.agendaId, peserta_id: App.state.user.id }
                    });
                    App.ui.load(false);
                    if(r.success){
                        App.state.mapelList = r.data || [];
                        Dashboard.showMapel();
                    } else {
                        Swal.fire({icon:'error', title:'Error', text:r.message, confirmButtonColor:'#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor:'#dc2626'});
                }
            },

            showMapel: () => {
                document.getElementById('secToken').classList.add('d-none');
                document.getElementById('secMapel').classList.remove('d-none');

                const cont = document.getElementById('mapelListContainer');
                cont.innerHTML = '';

                App.state.mapelList.forEach(m => {
                    let status = m.status_kerjakan;
                    if(status) status = status.trim();

                    let btn = '';
                    let cardClass = '';

                    if(status === 'Selesai') {
                        btn = `<button class="btn btn-secondary w-100 rounded-3 py-2 fw-bold" disabled><i class="bi bi-check-circle-fill"></i> SELESAI</button>`;
                        cardClass = 'bg-light border-success';
                    } else if(status === 'Proses' || status === 'Lanjut') {
                        btn = `<button class="btn btn-warning text-white w-100 rounded-3 py-2 fw-bold" onclick="Exam.confirm(${m.id})"><i class="bi bi-play-fill"></i> LANJUTKAN</button>`;
                        cardClass = 'border-warning';
                    } else {
                        btn = `<button class="btn btn-primary-custom w-100 rounded-3 py-2 fw-bold" onclick="Exam.confirm(${m.id})">MULAI KERJAKAN</button>`;
                    }

                    cont.innerHTML += `
                    <div class="col-md-6">
                        <div class="card shadow-sm rounded-4 p-3 h-100 ${cardClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-1">${m.nama_mata_pelajaran}</h6>
                                    <small class="text-muted"><i class="bi bi-clock"></i> ${m.durasi_ujian} Menit â€¢ <i class="bi bi-file-text"></i> ${m.jumlah_soal} Soal</small>
                                </div>
                                <div style="width:150px">${btn}</div>
                            </div>
                        </div>
                    </div>`;
                });
            }
        };

        // MODULE: EXAM ENGINE
        const Exam = {
            confirm: (mid) => {
                App.state.tempMapelId = mid;
                document.getElementById('checkAgree').checked = false;
                document.getElementById('btnStartReal').disabled = true;
                new bootstrap.Modal(document.getElementById('modalRules')).show();
                document.getElementById('checkAgree').onchange = (e) => {
                    document.getElementById('btnStartReal').disabled = !e.target.checked;
                };
            },

            startReal: async () => {
                bootstrap.Modal.getInstance(document.getElementById('modalRules')).hide();
                App.ui.load(true, 'Menyiapkan Soal...');

                try {
                    const r = await apiFetch('/api/get-soal', {
                        method: 'POST',
                        body: {
                            agenda_id: App.state.agendaId,
                            peserta_id: App.state.user.id,
                            mapel_id: App.state.tempMapelId
                        }
                    });

                    App.ui.load(false);

                    if(r.success) {
                        if(r.status === 'Selesai') {
                            Swal.fire({icon:'info', title:'Info', text:'Ujian ini sudah Anda selesaikan.', confirmButtonColor:'#dc2626'})
                                .then(() => Dashboard.refreshMapel());
                            return;
                        }

                        App.state.soal = r.data_soal;
                        App.state.activeMapel = r.mapel_detail;
                        App.state.jawaban = r.jawaban_sebelumnya ? r.jawaban_sebelumnya.split('|') : Array(r.data_soal.length).fill('-');
                        App.state.ragu = Array(r.data_soal.length).fill(false);
                        App.state.endTime = new Date(r.waktu_mulai).getTime() + (r.mapel_detail.durasi_ujian * 60000);

                        App.ui.view('viewUjian');
                        App.state.currentSoalIdx = 0;
                        Exam.renderSoal();
                        Exam.timer();
                        Exam.antiCheat();
                    } else {
                        Swal.fire({icon:'error', title:'Error', text:r.message, confirmButtonColor:'#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor:'#dc2626'});
                }
            },

            renderSoal: () => {
                const s = App.state.soal[App.state.currentSoalIdx];
                const j = App.state.jawaban[App.state.currentSoalIdx];
                const rawType = s.type_soal || 'Pilihan Ganda';
                const type = rawType.trim();

                document.getElementById('ujianMapelName').innerText = App.state.activeMapel.nama_mata_pelajaran || 'Ujian';
                document.getElementById('checkRagu').checked = App.state.ragu[App.state.currentSoalIdx];

                let h = `<div class="d-flex justify-content-between align-items-center mb-4"><span class="badge bg-danger rounded-pill px-3 py-2 fs-6">Soal No ${App.state.currentSoalIdx+1}</span><span class="badge bg-light text-dark border fs-6">${type}</span></div>`;

                if(s.gambar_url) h += `<div class="text-center mb-4"><img src="${s.gambar_url}" class="img-fluid rounded shadow-sm" style="max-height:300px"></div>`;
                h += `<div class="fs-5 mb-4 lh-base">${s.pertanyaan}</div>`;

                // 1. PG KOMPLEKS
                if (type.includes('Kompleks')) {
                    h += `<div class="alert alert-info py-2 small mb-4"><i class="bi bi-info-circle"></i> Pilih lebih dari satu jawaban.</div>`;
                    ['a','b','c','d','e'].forEach(o => {
                        const txt = s[`pilihan_${o}`];
                        if(txt && txt !== "") {
                            const isChecked = (j || '').includes(o.toUpperCase());
                            const selClass = isChecked ? 'selected' : '';
                            const icon = isChecked ? '<i class="bi bi-check-square-fill text-danger fs-5"></i>' : '<i class="bi bi-square text-secondary fs-5"></i>';
                            h += `<div class="option-item ${selClass}" onclick="Exam.ansPGComplex('${o.toUpperCase()}')"><div class="option-label">${o.toUpperCase()}</div><div class="flex-grow-1">${txt}</div><div>${icon}</div></div>`;
                        }
                    });
                }

                // 2. TIPE TABEL (PERNYATAAN 1-8)
                else if (type.includes('Benar') || type.includes('Salah') || type.includes('Setuju') || type.includes('Tidak')) {
                    const isBS = (type.includes('Benar') || type.includes('Salah'));
                    const col1 = isBS ? 'Benar (B)' : 'Setuju (S)';
                    const col2 = isBS ? 'Salah (S)' : 'Tidak (T)';
                    const val1 = isBS ? 'B' : 'S';
                    const val2 = isBS ? 'S' : 'T';

                    h += `<div class="table-responsive"><table class="table table-bordered align-middle"><thead class="table-light text-center"><tr><th class="text-start">Pernyataan</th><th style="width:120px">${col1}</th><th style="width:120px">${col2}</th></tr></thead><tbody>`;

                    let adaPernyataan = false;
                    for(let i=1; i<=8; i++) {
                        const txt = s[`pernyataan_${i}`];
                        if(txt && txt !== "") {
                            adaPernyataan = true;
                            const dataIndex = i - 1;
                            const currentVal = (j && j.length > dataIndex) ? j[dataIndex] : '-';

                            h += `<tr><td class="align-middle">${txt}</td>
                                    <td class="text-center align-middle"><input type="radio" class="form-check-input fs-4" style="cursor:pointer" name="row_${dataIndex}" ${currentVal === val1 ? 'checked' : ''} onclick="Exam.ansTable(${dataIndex}, '${val1}')"></td>
                                    <td class="text-center align-middle"><input type="radio" class="form-check-input fs-4" style="cursor:pointer" name="row_${dataIndex}" ${currentVal === val2 ? 'checked' : ''} onclick="Exam.ansTable(${dataIndex}, '${val2}')"></td>
                                  </tr>`;
                        }
                    }
                    if(!adaPernyataan) {
                        h += `<tr><td colspan="3" class="text-center text-danger p-3"><em>Data pernyataan kosong. Cek kolom pernyataan_1 s.d pernyataan_8 di database.</em></td></tr>`;
                    }
                    h += `</tbody></table></div>`;
                }

                // 3. PENJODOHAN
                else if (type.includes('Penjodohan') || type.includes('Menjodohkan')) {
                    h += `<div class="alert alert-info py-2 small mb-4"><i class="bi bi-info-circle"></i> Klik pernyataan di kiri, lalu klik jawaban di kanan untuk menjodohkannya.</div>`;

                    const leftStatements = [];
                    const rightStatements = [];
                    for(let i=1; i<=8; i++) {
                        if(s[`pernyataan_kiri_${i}`] && s[`pernyataan_kiri_${i}`].trim() !== '') leftStatements.push({ index: i, text: s[`pernyataan_kiri_${i}`] });
                        if(s[`pernyataan_kanan_${i}`] && s[`pernyataan_kanan_${i}`].trim() !== '') rightStatements.push({ letter: String.fromCharCode(64 + i), text: s[`pernyataan_kanan_${i}`] });
                    }

                    App.state.selectedLeftIndex = null;

                    h += `<div class="connection-grid">`;
                    h += `<div class="connection-column"><h6>Pernyataan</h6>`;
                    leftStatements.forEach(item => {
                        h += `<div class="connection-item left-item" data-index="${item.index}" onclick="Exam.handleConnectionClick(event)">${item.index}. ${item.text}</div>`;
                    });
                    h += `</div>`;
                    h += `<div class="connection-column"><h6>Pilihan</h6>`;
                    rightStatements.forEach(item => {
                        h += `<div class="connection-item right-item" data-letter="${item.letter}" onclick="Exam.handleConnectionClick(event)">${item.letter}. ${item.text}</div>`;
                    });
                    h += `</div></div>`;

                    h += `<div class="connection-display"><h6>Hasil Jodohan:</h6><div id="connection-list"></div></div>`;
                }

                // 4. ESSAY
                else if (type.includes('Uraian') || type.includes('Essay')) {
                    h += `<textarea class="form-control rounded-3 p-3" rows="6" placeholder="Ketik jawaban Anda disini..." oninput="Exam.ansEssay(this.value)">${j==='-'?'':(j||'')}</textarea>`;
                }

                // 5. DEFAULT: PG TUNGGAL
                else {
                    ['a','b','c','d','e'].forEach(o => {
                        const txt = s[`pilihan_${o}`];
                        if(txt && txt !== "") {
                            const sel = j === o.toUpperCase() ? 'selected' : '';
                            h += `<div class="option-item ${sel}" onclick="Exam.ansPGSingle('${o.toUpperCase()}')"><div class="option-label">${o.toUpperCase()}</div><div class="flex-grow-1">${txt}</div></div>`;
                        }
                    });
                }

                document.getElementById('soalContainer').innerHTML = h;
                if (type.includes('Penjodohan')) {
                    Exam.renderConnections();
                }
                Exam.navUpdate();
            },

            // --- LOGIKA MENJAWAB ---
            ansPGSingle: (val) => { Exam.saveAnswer(val); Exam.renderSoal(); },
            ansPGComplex: (val) => {
                let current = App.state.jawaban[App.state.currentSoalIdx];
                if(current === '-') current = '';
                let arr = current.split('');
                if(arr.includes(val)) arr = arr.filter(x => x !== val); else arr.push(val);
                let newVal = arr.sort().join('');
                if(newVal === '') newVal = '-';
                Exam.saveAnswer(newVal);
                Exam.renderSoal();
            },

            ansTable: (rowIndex, val) => {
                let current = App.state.jawaban[App.state.currentSoalIdx];
                const s = App.state.soal[App.state.currentSoalIdx];

                let statementCount = 0;
                for(let i=1; i<=8; i++) {
                    if(s[`pernyataan_${i}`] && s[`pernyataan_${i}`].trim() !== '') statementCount++;
                }

                if(!current || current === '-' || current.length < statementCount) current = Array(statementCount).fill('-').join('');
                let arr = current.split('');
                arr[rowIndex] = val;

                Exam.saveAnswer(arr.join(''));
                Exam.navUpdate();
            },

            handleConnectionClick: (event) => {
                const target = event.target;
                if (!target.classList.contains('connection-item')) return;

                const isLeft = target.classList.contains('left-item');
                const isRight = target.classList.contains('right-item');

                if (isLeft) {
                    document.querySelectorAll('.left-item').forEach(item => item.classList.remove('active-left'));
                    target.classList.add('active-left');
                    App.state.selectedLeftIndex = target.dataset.index;
                } else if (isRight && App.state.selectedLeftIndex) {
                    const leftIndex = App.state.selectedLeftIndex;
                    const rightLetter = target.dataset.letter;
                    Exam.updateConnection(leftIndex, rightLetter);
                }
            },

            updateConnection: (leftIndex, rightLetter) => {
                let answerString = App.state.jawaban[App.state.currentSoalIdx] || '-';
                const answers = {};
                if (answerString !== '-') {
                    for (let i = 0; i < answerString.length; i += 2) {
                        const num = answerString.substring(i, i + 1);
                        const letter = answerString.substring(i + 1, i + 2);
                        answers[num] = letter;
                    }
                }

                if (answers[leftIndex] === rightLetter) {
                    delete answers[leftIndex];
                } else {
                    answers[leftIndex] = rightLetter;
                }

                App.state.selectedLeftIndex = null;
                document.querySelectorAll('.left-item').forEach(item => item.classList.remove('active-left'));

                const newAnswerString = Object.keys(answers)
                    .map(Number)
                    .sort((a, b) => a - b)
                    .map(num => `${num}${answers[num]}`)
                    .join('');

                Exam.saveAnswer(newAnswerString || '-');
                Exam.renderConnections();
            },

            renderConnections: () => {
                const answerString = App.state.jawaban[App.state.currentSoalIdx] || '-';
                const answers = {};
                if (answerString !== '-') {
                    for (let i = 0; i < answerString.length; i += 2) {
                        const num = answerString.substring(i, i + 1);
                        const letter = answerString.substring(i + 1, i + 2);
                        answers[num] = letter;
                    }
                }

                document.querySelectorAll('.connection-item').forEach(item => item.classList.remove('connected'));

                Object.keys(answers).forEach(num => {
                    const letter = answers[num];
                    const leftEl = document.querySelector(`.left-item[data-index="${num}"]`);
                    const rightEl = document.querySelector(`.right-item[data-letter="${letter}"]`);
                    if(leftEl) leftEl.classList.add('connected');
                    if(rightEl) rightEl.classList.add('connected');
                });

                const listContainer = document.getElementById('connection-list');
                if(listContainer) {
                    listContainer.innerHTML = '';
                    if (Object.keys(answers).length === 0) {
                        listContainer.innerHTML = '<span class="text-muted">Belum ada jodohan.</span>';
                    } else {
                        Object.keys(answers).forEach(num => {
                            const letter = answers[num];
                            listContainer.innerHTML += `<span class="connection-list-item">${num} &rarr; ${letter}</span>`;
                        });
                    }
                }
            },

            ansEssay: (val) => { Exam.saveAnswer(val); },

            queueSaveToServer: () => {
                if (App.state.saveDebounce) clearTimeout(App.state.saveDebounce);
                App.state.saveDebounce = setTimeout(async () => {
                    try {
                        const str = App.state.jawaban.map(j=>j||'-').join('|');
                        await apiFetch('/api/save-jawaban', {
                            method: 'POST',
                            body: {
                                pid: App.state.user.id,
                                aid: App.state.agendaId,
                                mid: App.state.activeMapel.id,
                                jwb: str
                            }
                        });
                    } catch (e) {
                        // sengaja silent biar tidak ganggu ujian; kalau mau tampilkan bisa
                        console.warn('Autosave gagal:', e.message);
                    }
                }, 800);
            },

            saveAnswer: (val) => {
                App.state.jawaban[App.state.currentSoalIdx] = val || '-';
                App.data.save(`ans_${App.state.activeMapel.id}`, App.state.jawaban);
                Exam.navUpdate();
                Exam.queueSaveToServer();
            },

            toggleRagu: () => {
                App.state.ragu[App.state.currentSoalIdx] = document.getElementById('checkRagu').checked;
                Exam.navUpdate();
            },

            navSoal: (d) => {
                const next = App.state.currentSoalIdx + d;
                App.state.currentSoalIdx = Math.max(0, Math.min(next, App.state.soal.length - 1));
                Exam.renderSoal();
            },

            navUpdate: () => {
                document.getElementById('btnPrev').disabled = App.state.currentSoalIdx === 0;
                const bn = document.getElementById('btnNext');
                if(App.state.currentSoalIdx === App.state.soal.length - 1) {
                    bn.innerHTML = 'SELESAI';
                    bn.className = 'btn btn-danger rounded-pill fw-bold px-4';
                    bn.onclick = () => Exam.finish(false);
                } else {
                    bn.innerHTML = 'Selanjutnya';
                    bn.className = 'btn btn-danger rounded-pill fw-bold px-4';
                    bn.onclick = () => Exam.navSoal(1);
                }

                const g = document.getElementById('navGridDesktop');
                g.innerHTML = '';
                App.state.soal.forEach((_, i) => {
                    let c = '';
                    if(i===App.state.currentSoalIdx) c='active';
                    else if(App.state.ragu[i]) c='ragu';
                    else if(App.state.jawaban[i] && App.state.jawaban[i] !== '-') c='filled';
                    g.innerHTML += `<button class="nav-item-btn ${c}" onclick="App.state.currentSoalIdx=${i};Exam.renderSoal()">${i+1}</button>`;
                });
            },

            timer: () => {
                if(App.state.timer) clearInterval(App.state.timer);
                App.state.timer = setInterval(() => {
                    const diff = App.state.endTime - Date.now();
                    if(diff < 0) {
                        clearInterval(App.state.timer);
                        Exam.finish(true);
                        return;
                    }
                    const h=Math.floor(diff/3600000),
                          m=Math.floor((diff%3600000)/60000),
                          s=Math.floor((diff%60000)/1000);
                    const timerEl = document.getElementById('timerDisplay');
                    timerEl.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(diff < 300000) timerEl.classList.add('timer-warning');
                }, 1000);
            },

            antiCheat: () => {
                if (App.state.antiCheatInstalled) return;
                App.state.antiCheatInstalled = true;

                document.addEventListener('visibilitychange', () => {
                    if(document.hidden && !document.getElementById('viewUjian').classList.contains('d-none')) {
                        new bootstrap.Modal(document.getElementById('modalViolation')).show();
                        App.state.cheatTimer = 30;
                        document.getElementById('violationTimer').innerText = 30;
                        document.getElementById('btnResumeExam').classList.remove('d-none');
                        document.getElementById('btnForceFinish').classList.add('d-none');

                        if(App.state.cheatInterval) clearInterval(App.state.cheatInterval);
                        App.state.cheatInterval = setInterval(() => {
                            App.state.cheatTimer--;
                            document.getElementById('violationTimer').innerText = App.state.cheatTimer;
                            if(App.state.cheatTimer <= 0) {
                                clearInterval(App.state.cheatInterval);
                                document.getElementById('violationTimer').innerText = "WAKTU HABIS";
                                document.getElementById('btnResumeExam').classList.add('d-none');
                                document.getElementById('btnForceFinish').classList.remove('d-none');
                                document.getElementById('btnForceFinish').onclick = () => Exam.finish(true);
                            }
                        }, 1000);
                    }
                });
            },

            resume: () => {
                clearInterval(App.state.cheatInterval);
                bootstrap.Modal.getInstance(document.getElementById('modalViolation')).hide();
            },

            finish: async (force) => {
                if(!force && !confirm('Yakin ingin menyelesaikan ujian?')) return;

                App.ui.load(true, 'Menyimpan...');
                clearInterval(App.state.timer);
                clearInterval(App.state.cheatInterval);

                const str = App.state.jawaban.map(j=>j||'-').join('|');

                try {
                    const r = await apiFetch('/api/selesai-ujian', {
                        method: 'POST',
                        body: {
                            pid: App.state.user.id,
                            aid: App.state.agendaId,
                            mid: App.state.activeMapel.id,
                            jwb: str
                        }
                    });

                    App.ui.load(false);
                    const vModal = bootstrap.Modal.getInstance(document.getElementById('modalViolation'));
                    if(vModal) vModal.hide();

                    if(r.success) {
                        Swal.fire({icon:'success', title:'Sukses', text:'Ujian telah selesai dan disimpan.', confirmButtonColor:'#10b981'})
                            .then(() => Dashboard.refreshMapel());
                    } else {
                        Swal.fire({icon:'error', title:'Error', text:r.message, confirmButtonColor:'#dc2626'});
                    }
                } catch (err) {
                    App.ui.load(false);
                    Swal.fire({icon:'error', title:'Error', text: err.message, confirmButtonColor:'#dc2626'});
                }
            }
        };

        // EXPORTS
        window.loadAgendaDropdown = Auth.loadAgendas;
        window.downloadKartu = () => html2canvas(document.getElementById('kartuArea')).then(c => {
            const a=document.createElement('a');
            a.download='Kartu Peserta CBT PRO.png';
            a.href=c.toDataURL();
            a.click();
        });
        window.tutupKartuKeLogin = () => {
            bootstrap.Modal.getInstance(document.getElementById('modalKartu')).hide();
            document.querySelector('[data-bs-target="#tabLogin"]').click();
        };
        window.Auth = Auth;
        window.Dashboard = Dashboard;
        window.Exam = Exam;
        window.Ui = Ui;
        window.onload = Auth.init;
    </script>
</body>
</html>
