<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CBT PRO - Ujian Online</title>

  <!-- Fonts & CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    :root {
      --primary: #dc2626;
      --primary-hover: #b91c1c;
      --bg: #f7f8fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e5e7eb;

      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;

      --shadow-sm: 0 10px 15px -3px rgba(2, 6, 23, 0.06);
      --shadow-md: 0 18px 30px -10px rgba(2, 6, 23, 0.15);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }

    body.theme-dark {
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.25);
      --shadow-sm: 0 12px 18px -8px rgba(0, 0, 0, 0.35);
      --shadow-md: 0 26px 50px -22px rgba(0, 0, 0, 0.55);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      user-select: none;
    }

    /* subtle animated background */
    .bg-orbs {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    .orb {
      position: absolute;
      width: 520px;
      height: 520px;
      filter: blur(60px);
      opacity: 0.22;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(220,38,38,0.75), rgba(220,38,38,0));
      animation: float 12s ease-in-out infinite;
    }
    .orb.orb-2 {
      width: 560px;
      height: 560px;
      opacity: 0.18;
      background: radial-gradient(circle at 30% 30%, rgba(59,130,246,0.65), rgba(59,130,246,0));
      animation-duration: 14s;
    }
    .orb.orb-3 {
      width: 620px;
      height: 620px;
      opacity: 0.14;
      background: radial-gradient(circle at 30% 30%, rgba(16,185,129,0.60), rgba(16,185,129,0));
      animation-duration: 16s;
    }
    @keyframes float {
      0%, 100% { transform: translate(0,0) scale(1); }
      50% { transform: translate(18px,-22px) scale(1.03); }
    }
    @media (prefers-reduced-motion: reduce) {
      .orb { animation: none; }
      .animate__animated { animation: none !important; }
    }

    /* Loader */
    .loader-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }
    body.theme-dark .loader-overlay {
      background: rgba(2, 6, 23, 0.70);
    }
    .spinner-ring {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 5px solid rgba(100,116,139,.25);
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Shared cards */
    .soft-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    /* Buttons */
    .btn-primary-custom {
      background-color: var(--primary);
      border-color: var(--primary);
      color: #fff;
      font-weight: 700;
      border-radius: 14px;
      transition: all 0.18s ease-in-out;
    }
    .btn-primary-custom:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(220, 38, 38, 0.28);
    }

    /* Theme toggle */
    .theme-btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      border-radius: 12px;
      padding: 10px 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
    }
    .theme-btn:hover { color: var(--text); }

    /* AUTH */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .auth-shell {
      width: 100%;
      max-width: 1040px;
      overflow: hidden;
      border-radius: 26px;
    }
    .auth-left {
      position: relative;
      color: #fff;
      background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%);
      min-height: 100%;
    }
    .auth-left::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 20% 15%, rgba(255,255,255,.18), transparent 45%),
        radial-gradient(circle at 85% 25%, rgba(255,255,255,.12), transparent 42%),
        radial-gradient(circle at 40% 90%, rgba(255,255,255,.10), transparent 40%);
      pointer-events:none;
    }
    .auth-left-inner {
      position: relative;
      z-index: 1;
      padding: 44px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 24px;
    }
    .brand-badge {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      letter-spacing: .08em;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
    }
    .auth-title { font-weight: 900; letter-spacing: -0.02em; margin: 0; }
    .auth-sub { opacity: .92; margin: 0; }
    .feature {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
    }
    .feature i { font-size: 1.2rem; }
    .feature h6 { margin: 0; font-weight: 800; }
    .feature p { margin: 2px 0 0; opacity: .90; font-size: .92rem; }

    .auth-right {
      background: var(--card);
      padding: 34px;
    }

    .auth-switch {
      background: rgba(100,116,139,.08);
      border: 1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    body.theme-dark .auth-switch { background: rgba(148,163,184,.10); }
    .auth-switch .nav-link {
      border-radius: 999px !important;
      font-weight: 800;
      color: var(--muted);
    }
    .auth-switch .nav-link.active {
      background: var(--primary) !important;
      color: #fff !important;
      box-shadow: 0 12px 24px rgba(220, 38, 38, 0.25);
    }

    .form-control, .form-select {
      border-radius: 14px;
      border-color: var(--border);
      background: var(--card);
      color: var(--text);
    }
    body.theme-dark .form-control,
    body.theme-dark .form-select {
      background: rgba(255,255,255,0.02);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(220, 38, 38, 0.20);
    }
    .password-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      z-index: 10;
    }
    .form-floating > .form-control { padding-right: 3.5rem; }

    /* Dashboard */
    .topbar {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(220,38,38,.10);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      border: 1px solid rgba(220,38,38,.22);
    }
    .agenda-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--card);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      box-shadow: var(--shadow-sm);
    }
    .agenda-card:hover {
      transform: translateY(-3px);
      border-color: rgba(220,38,38,.45);
      box-shadow: 0 18px 30px -18px rgba(220,38,38,.28);
    }

    /* Ujian Layout */
    .ujian-navbar {
      height: 70px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1030;
      box-shadow: var(--shadow-sm);
    }
    .timer-badge {
      font-weight: 900;
      font-size: 1.05rem;
      background: rgba(100,116,139,.08);
      color: var(--primary);
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      letter-spacing: 0.06em;
    }
    .timer-warning {
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.35);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.03); opacity: 0.86; }
    }
    .ujian-layout { margin-top: 90px; padding-bottom: 86px; }
    .soal-card {
      background: var(--card);
      padding: 26px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      min-height: 380px;
      box-shadow: var(--shadow-md);
    }

    /* Option items */
    .option-item {
      display: flex;
      align-items: center;
      padding: 16px;
      margin-bottom: 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: all .15s ease;
      background: rgba(100,116,139,.03);
    }
    body.theme-dark .option-item { background: rgba(255,255,255,.02); }
    .option-item:hover { border-color: rgba(100,116,139,.5); }
    .option-item.selected {
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.55);
      color: var(--text);
    }
    .option-label {
      width: 40px;
      height: 40px;
      background: rgba(100,116,139,.75);
      color: #fff;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      margin-right: 14px;
      flex-shrink: 0;
    }
    .option-item.selected .option-label { background: var(--primary); }

    /* Nav grid */
    .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .nav-item-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 12px;
      font-weight: 800;
      color: var(--muted);
      transition: all .15s ease;
    }
    .nav-item-btn:hover { border-color: rgba(220,38,38,.45); color: var(--primary); }
    .nav-item-btn.active { border-color: rgba(220,38,38,.65); color: var(--primary); background: rgba(220,38,38,.10); }
    .nav-item-btn.filled { background: var(--primary); color: #fff; border-color: rgba(220,38,38,.8); }
    .nav-item-btn.ragu { background: var(--warning); color: #fff; border-color: rgba(245,158,11,.9); }

    .ujian-footer {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--card);
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1020;
      box-shadow: var(--shadow-sm);
    }

    /* Matching grid */
    .connection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .connection-column {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: rgba(100,116,139,.03);
    }
    body.theme-dark .connection-column { background: rgba(255,255,255,.02); }
    .connection-column h6 { font-weight: 900; margin-bottom: 12px; }
    .connection-item {
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all .14s ease;
      border: 1px solid transparent;
      margin-bottom: 10px;
      background: rgba(100,116,139,.06);
    }
    body.theme-dark .connection-item { background: rgba(255,255,255,.03); }
    .connection-item:hover { transform: translateY(-1px); border-color: rgba(100,116,139,.35); }
    .connection-item.active-left {
      border-color: rgba(220,38,38,.65);
      background: rgba(220,38,38,.10);
      font-weight: 800;
    }
    .connection-item.connected {
      border-color: rgba(16,185,129,.65);
      background: rgba(16,185,129,.10);
      font-weight: 800;
    }
    .connection-display {
      background: rgba(100,116,139,.03);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }
    body.theme-dark .connection-display { background: rgba(255,255,255,.02); }
    .connection-display h6 { font-weight: 900; margin-bottom: 10px; }
    .connection-list-item {
      display: inline-block;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      margin: 4px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 991.98px) {
      .auth-left-inner { padding: 28px; }
      .auth-right { padding: 24px; }
    }
    @media (max-width: 576px) {
      .auth-container { padding: 12px; }
      .auth-right { padding: 18px; }
      .soal-card { padding: 18px; }
      .connection-grid { grid-template-columns: 1fr; }
      .timer-badge { padding: 8px 10px; font-size: 1rem; }
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="bg-orbs">
    <div class="orb" style="top:-160px; left:-140px;"></div>
    <div class="orb orb-2" style="top:10%; right:-180px;"></div>
    <div class="orb orb-3" style="bottom:-220px; left:20%;"></div>
  </div>

  <!-- LOADER -->
  <div id="loader" class="loader-overlay d-none">
    <div class="spinner-ring"></div>
    <div class="fw-bold" id="loaderText">Memuat Sistem...</div>
  </div>

  <!-- AUTH SCREEN -->
  <div id="viewAuth" class="auth-container">
    <div class="auth-shell soft-card row g-0 animate__animated animate__fadeIn">
      <!-- LEFT BRAND -->
      <div class="col-lg-5 auth-left">
        <div class="auth-left-inner">
          <div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="brand-badge">CBT</div>
              <button class="theme-btn" type="button" onclick="Theme.toggle()" title="Ganti Tema">
                <i class="bi bi-moon-stars-fill"></i>
                <span class="d-none d-md-inline">Tema</span>
              </button>
            </div>
            <h1 class="auth-title mt-3">CBT PRO</h1>
            <p class="auth-sub mt-2">Sistem ujian online yang cepat, responsif, dan mudah digunakan.</p>
          </div>

          <div class="d-grid gap-2">
            <div class="feature">
              <i class="bi bi-shield-lock-fill"></i>
              <div>
                <h6>Kontrol Ujian</h6>
                <p>Token ujian + timer, dan perlindungan anti-cheat dasar.</p>
              </div>
            </div>
            <div class="feature">
              <i class="bi bi-cloud-check-fill"></i>
              <div>
                <h6>Auto Save</h6>
                <p>Jawaban disimpan otomatis ke server selama ujian berjalan.</p>
              </div>
            </div>
            <div class="feature">
              <i class="bi bi-phone-fill"></i>
              <div>
                <h6>Responsif</h6>
                <p>Nyaman dipakai di HP, tablet, maupun komputer.</p>
              </div>
            </div>
          </div>

          <div class="small text-white-50">
            Pastikan jaringan stabil. Dilarang refresh saat ujian berlangsung.
          </div>
        </div>
      </div>

      <!-- RIGHT FORM -->
      <div class="col-lg-7 auth-right">
        <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
          <div>
            <h3 class="fw-black mb-1" style="font-weight: 900;">Selamat datang</h3>
            <div class="text-muted" style="color: var(--muted) !important;">Masuk atau daftar untuk melanjutkan.</div>
          </div>
          <button class="theme-btn d-lg-none" type="button" onclick="Theme.toggle()" title="Ganti Tema">
            <i class="bi bi-moon-stars-fill"></i>
          </button>
        </div>

        <ul class="nav nav-pills nav-fill auth-switch mb-4" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link w-100 active" data-bs-toggle="pill" data-bs-target="#tabLogin" type="button">Masuk</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#tabRegister" type="button" onclick="loadAgendaDropdown()">Daftar</button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- LOGIN -->
          <div class="tab-pane fade show active" id="tabLogin">
            <form onsubmit="Auth.login(event)">
              <div class="form-floating mb-3 position-relative">
                <input type="text" class="form-control" id="loginUser" placeholder="User" required autocomplete="username" />
                <label for="loginUser">Username / No WA</label>
              </div>

              <div class="form-floating mb-2 position-relative">
                <input type="password" class="form-control" id="loginPass" placeholder="Pass" required autocomplete="current-password" />
                <label for="loginPass">Password</label>
                <button type="button" class="password-toggle" onclick="Ui.togglePassword('loginPass', this)" aria-label="Toggle password">
                  <i class="bi bi-eye-slash-fill fs-5"></i>
                </button>
              </div>

              <div class="small mb-4" style="color: var(--muted);">
                Gunakan username/WA yang terdaftar.
              </div>

              <button class="btn btn-primary-custom w-100 py-3" type="submit">
                <i class="bi bi-box-arrow-in-right me-2"></i> MASUK
              </button>
            </form>
          </div>

          <!-- REGISTER -->
          <div class="tab-pane fade" id="tabRegister">
            <form onsubmit="Auth.register(event)">
              <select id="regAgenda" class="form-select py-3 mb-3" required>
                <option value="">Memuat Agenda...</option>
              </select>

              <div class="row g-2 mb-3">
                <div class="col-12">
                  <input type="text" id="regNama" class="form-control py-3" placeholder="Nama Lengkap" required autocomplete="name" />
                </div>
                <div class="col-6">
                  <select id="regJenjang" class="form-select py-3" required>
                    <option value="">Jenjang</option>
                    <option value="SD">SD</option>
                    <option value="SMP">SMP</option>
                    <option value="SMA">SMA</option>
                  </select>
                </div>
                <div class="col-6">
                  <input type="text" id="regKelas" class="form-control py-3" placeholder="Kelas" required />
                </div>
              </div>

              <input type="text" id="regSekolah" class="form-control py-3 mb-3" placeholder="Asal Sekolah" required />

              <!-- WA -->
              <input
                type="tel"
                inputmode="numeric"
                id="regWa"
                class="form-control py-3 mb-3"
                placeholder="No WA (Jadi Username)"
                oninput="this.value=this.value.replace(/\D/g,'').replace(/^0|^62/,'')"
                required
              />

              <input type="tel" inputmode="numeric" id="regWaOrtu" class="form-control py-3 mb-3" placeholder="No WA Ortu" required />

              <div class="form-floating mb-3 position-relative">
                <input type="password" class="form-control" id="regPass" placeholder="Password" required autocomplete="new-password" />
                <label for="regPass">Password</label>
                <button type="button" class="password-toggle" onclick="Ui.togglePassword('regPass', this)" aria-label="Toggle password">
                  <i class="bi bi-eye-slash-fill fs-5"></i>
                </button>
              </div>

              <button class="btn btn-success w-100 py-3 fw-bold" style="border-radius: 14px;" type="submit">
                <i class="bi bi-person-plus-fill me-2"></i> DAFTAR AKUN
              </button>

              <div class="small mt-3" style="color: var(--muted);">
                Data akun dipakai untuk akses ujian sesuai agenda.
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="viewDashboard" class="d-none animate__animated animate__fadeIn">
    <div class="topbar py-3 sticky-top">
      <div class="container d-flex justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <div class="avatar"><i class="bi bi-person-fill"></i></div>
          <div style="line-height:1.2">
            <div class="fw-bold" id="dashNama">Peserta</div>
            <div class="small" style="color: var(--muted);" id="dashSekolah">Sekolah</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="theme-btn" type="button" onclick="Theme.toggle()" title="Ganti Tema">
            <i class="bi bi-moon-stars-fill"></i>
            <span class="d-none d-md-inline">Tema</span>
          </button>
          <button class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold" onclick="Auth.logout()">Keluar</button>
        </div>
      </div>
    </div>

    <div class="container py-4">
      <!-- SECTION 1: AGENDA LIST -->
      <div id="secAgenda">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h4 class="fw-black mb-0" style="font-weight: 900;">Agenda Tersedia</h4>
          <div class="small" style="color: var(--muted);">
            Pilih agenda yang aktif untuk memulai.
          </div>
        </div>
        <div id="agendaListContainer" class="row g-3"></div>
      </div>

      <!-- SECTION 2: TOKEN INPUT -->
      <div id="secToken" class="d-none animate__animated animate__fadeInRight">
        <button class="btn btn-sm btn-light border mb-3" onclick="Dashboard.backToAgenda()">
          <i class="bi bi-arrow-left"></i> Kembali
        </button>
        <div class="soft-card p-4 p-md-5 text-center mx-auto" style="max-width: 540px;">
          <h4 class="fw-black mb-1" style="font-weight: 900; color: var(--primary);" id="tokenAgendaName">Ujian</h4>
          <p class="mb-4" style="color: var(--muted);">Masukkan Token Ujian</p>
          <input
            type="text"
            id="inputToken"
            class="form-control form-control-lg text-center fw-bold fs-1 mb-4 text-uppercase"
            maxlength="5"
            placeholder="_ _ _ _ _"
            style="letter-spacing: 6px; border-radius: 16px;"
          />
          <button class="btn btn-primary-custom w-100 py-3" onclick="Dashboard.verifyToken()">
            <i class="bi bi-shield-check me-2"></i> VERIFIKASI TOKEN
          </button>
        </div>
      </div>

      <!-- SECTION 3: MAPEL LIST -->
      <div id="secMapel" class="d-none animate__animated animate__fadeInUp">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h4 class="fw-black mb-0" style="font-weight: 900;">Daftar Mata Pelajaran</h4>
            <div class="small" style="color: var(--muted);">Pilih mapel untuk mulai/lanjut.</div>
          </div>
          <button class="btn btn-sm btn-light border" onclick="Dashboard.backToAgenda()">Ganti Agenda</button>
        </div>
        <div id="mapelListContainer" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- UJIAN ENGINE -->
  <div id="viewUjian" class="d-none min-vh-100" style="background: var(--bg);">
    <div class="ujian-navbar">
      <div>
        <div class="fw-black" style="font-weight: 900;" id="ujianMapelName">Mapel</div>
        <small style="color: var(--muted);" class="d-none d-md-block">Dilarang Refresh Halaman!</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="theme-btn d-none d-md-inline-flex" type="button" onclick="Theme.toggle()" title="Ganti Tema">
          <i class="bi bi-moon-stars-fill"></i>
          <span>Tema</span>
        </button>
        <div id="timerDisplay" class="timer-badge">00:00:00</div>
      </div>
    </div>

    <div class="container ujian-layout">
      <div class="row g-3">
        <div class="col-lg-9">
          <div id="soalContainer" class="soal-card animate__animated animate__fadeIn"></div>
        </div>

        <div class="col-lg-3 d-none d-lg-block">
          <div class="soft-card sticky-top" style="top: 90px;">
            <div class="p-3 pb-0">
              <div class="fw-black" style="font-weight: 900;">Navigasi Soal</div>
              <div class="small" style="color: var(--muted);">Klik nomor untuk lompat soal.</div>
            </div>
            <div class="p-3">
              <div id="navGridDesktop" class="nav-grid"></div>
              <button class="btn btn-danger w-100 mt-4 rounded-3 fw-bold" onclick="Exam.finish(false)">
                <i class="bi bi-check2-circle me-2"></i> SELESAIKAN UJIAN
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="ujian-footer">
      <button class="btn btn-outline-secondary rounded-pill fw-bold px-4" id="btnPrev" onclick="Exam.navSoal(-1)">
        Sebelumnya
      </button>

      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="checkRagu" onchange="Exam.toggleRagu()" />
        <label class="form-check-label fw-bold" style="color: var(--warning);">Ragu</label>
      </div>

      <button class="btn btn-danger rounded-pill fw-bold px-4" id="btnNext" onclick="Exam.navSoal(1)">
        Selanjutnya
      </button>
    </div>
  </div>

  <!-- MODAL RULES -->
  <div class="modal fade" id="modalRules" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content soft-card" style="border-radius: 18px;">
        <div class="modal-header" style="background: var(--primary); color:#fff; border-bottom: 0;">
          <h5 class="modal-title fw-black" style="font-weight: 900;">Tata Tertib Ujian</h5>
        </div>
        <div class="modal-body p-4">
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div><strong>Perhatian!</strong> Waktu berjalan saat tombol mulai ditekan.</div>
          </div>
          <ol class="list-group list-group-numbered list-group-flush mb-3">
            <li class="list-group-item">Dilarang membuka tab lain atau aplikasi lain.</li>
            <li class="list-group-item">Sistem mendeteksi jika Anda keluar (Anti-Cheat).</li>
            <li class="list-group-item">Jika terdeteksi keluar, hitungan mundur 30 detik akan dimulai untuk auto-submit.</li>
          </ol>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="checkAgree" />
            <label class="form-check-label fw-bold" for="checkAgree">Saya mengerti dan siap mengerjakan dengan jujur.</label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-danger px-4 fw-bold" id="btnStartReal" disabled onclick="Exam.startReal()">
            MULAI MENGERJAKAN
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL VIOLATION (ANTI CHEAT) -->
  <div class="modal fade" id="modalViolation" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content soft-card" style="border-radius: 18px;">
        <div class="modal-body p-5 text-center">
          <div class="mb-3" style="color: var(--primary);"><i class="bi bi-exclamation-octagon-fill display-1"></i></div>
          <h3 class="fw-black" style="font-weight: 900; color: var(--primary);">PERINGATAN!</h3>
          <p class="mb-4" style="color: var(--muted);">Anda meninggalkan halaman ujian.<br/>Ujian akan otomatis diselesaikan dalam:</p>
          <h1 class="fw-black mb-4 display-3" style="font-weight: 900;" id="violationTimer">30</h1>
          <button id="btnResumeExam" class="btn btn-outline-dark rounded-pill px-5 fw-bold" onclick="Exam.resume()">LANJUTKAN UJIAN</button>
          <button id="btnForceFinish" class="btn btn-danger rounded-pill px-5 fw-bold d-none">SELESAIKAN SEKARANG</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL KARTU -->
  <div class="modal fade" id="modalKartu">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content soft-card" style="border-radius: 18px;">
        <div class="modal-body text-center p-4">
          <h5 class="fw-black mb-3" style="font-weight:900; color: var(--success);">Registrasi Berhasil!</h5>

          <div id="kartuArea" class="border p-3 text-start mb-3" style="background: var(--card); border-radius: 14px; border-color: var(--border) !important;">
            <h6 class="text-center fw-black border-bottom pb-2" style="font-weight:900;">KARTU PESERTA</h6>
            <table class="table table-sm table-borderless mb-0">
              <tr><td>Nama</td><td class="fw-bold" id="cardNama"></td></tr>
              <tr><td>User</td><td class="fw-bold" style="color: var(--primary);" id="cardUser"></td></tr>
              <tr><td>Pass</td><td class="fw-bold" id="cardPass"></td></tr>
              <tr><td>Agenda</td><td id="cardAgenda"></td></tr>
            </table>
          </div>

          <button class="btn btn-primary-custom w-100 mb-2" onclick="downloadKartu()">
            <i class="bi bi-download me-2"></i> Download
          </button>
          <button class="btn btn-light border w-100" onclick="tutupKartuKeLogin()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
    async function apiFetch(path, { method = 'GET', body, query } = {}) {
      let url = path;
      if (query) {
        const qs = new URLSearchParams(query).toString();
        url += `?${qs}`;
      }

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
      return data;
    }

    // THEME
    const Theme = {
      load: () => {
        const t = localStorage.getItem('cbt_theme') || 'light';
        document.body.classList.toggle('theme-dark', t === 'dark');
      },
      toggle: () => {
        const isDark = document.body.classList.toggle('theme-dark');
        localStorage.setItem('cbt_theme', isDark ? 'dark' : 'light');
      }
    };

    // GLOBAL STATE
    const App = {
      state: {
        user: null,
        agendaId: null,
        mapelList: [],
        activeMapel: null,
        tempMapelId: null,
        soal: [],
        jawaban: [],
        ragu: [],
        endTime: 0,
        timer: null,
        currentSoalIdx: 0,
        dashInterval: null,
        cheatTimer: 30,
        cheatInterval: null,
        selectedLeftIndex: null,
        antiCheatInstalled: false,
        saveDebounce: null
      },
      ui: {
        load: (s, t = 'Memuat...') => {
          document.getElementById('loaderText').innerText = t;
          document.getElementById('loader').classList.toggle('d-none', !s);
        },
        view: (id) => {
          ['viewAuth','viewDashboard','viewUjian'].forEach(v => document.getElementById(v).classList.add('d-none'));
          document.getElementById(id).classList.remove('d-none');
        }
      },
      data: {
        save: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
        get: (k) => JSON.parse(localStorage.getItem(k)),
        remove: (k) => localStorage.removeItem(k)
      }
    };

    // UI HELPERS
    const Ui = {
      togglePassword: (inputId, button) => {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('bi-eye-slash-fill');
          icon.classList.add('bi-eye-fill');
        } else {
          input.type = 'password';
          icon.classList.remove('bi-eye-fill');
          icon.classList.add('bi-eye-slash-fill');
        }
      }
    };

    // AUTH
    const Auth = {
      init: () => {
        Theme.load();
        const u = App.data.get('cbt_user');
        if (u) {
          App.state.user = u;
          Dashboard.show();
        } else {
          App.ui.view('viewAuth');
        }
      },

      login: async (e) => {
        e.preventDefault();
        App.ui.load(true, 'Login...');
        try {
          const r = await apiFetch('/api/login', {
            method: 'POST',
            body: {
              u: document.getElementById('loginUser').value,
              p: document.getElementById('loginPass').value
            }
          });
          App.ui.load(false);

          if (r.success) {
            App.state.user = r.data;
            App.data.save('cbt_user', r.data);
            Dashboard.show();
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      },

      register: async (e) => {
        e.preventDefault();
        App.ui.load(true, 'Daftar...');

        // NOTE: password dikirim apa adanya (tidak di-hash di frontend)
        const f = {
          agenda_id: document.getElementById('regAgenda').value,
          nama: document.getElementById('regNama').value,
          jenjang: document.getElementById('regJenjang').value,
          kelas: document.getElementById('regKelas').value,
          sekolah: document.getElementById('regSekolah').value,
          no_wa: document.getElementById('regWa').value,
          wa_ortu: document.getElementById('regWaOrtu').value,
          password: document.getElementById('regPass').value,
          username: document.getElementById('regWa').value.replace(/\D/g,'').replace(/^0|^62/,'')
        };

        try {
          const r = await apiFetch('/api/register', { method: 'POST', body: f });
          App.ui.load(false);

          if (r.success) {
            document.getElementById('cardNama').innerText = f.nama;
            document.getElementById('cardUser').innerText = f.username;
            document.getElementById('cardPass').innerText = f.password;
            document.getElementById('cardAgenda').innerText = r.nama_agenda || '-';
            new bootstrap.Modal(document.getElementById('modalKartu')).show();
            e.target.reset();
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      },

      loadAgendas: async () => {
        const s = document.getElementById('regAgenda');
        if (s.options.length > 1) return;

        try {
          const r = await apiFetch('/api/agenda');
          s.innerHTML = '<option value="">Pilih Agenda</option>';
          (r.data || []).forEach(a => {
            s.innerHTML += `<option value="${a.id}">${a.agenda_ujian}</option>`;
          });
        } catch (err) {
          s.innerHTML = '<option value="">Gagal memuat agenda</option>';
        }
      },

      logout: () => {
        Swal.fire({
          icon: 'question',
          title: 'Keluar?',
          text: 'Apakah Anda yakin ingin keluar?',
          showCancelButton: true,
          confirmButtonColor: '#dc2626',
          cancelButtonColor: '#64748b',
          confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
          if (result.isConfirmed) {
            App.data.remove('cbt_user');
            if (App.state.dashInterval) clearInterval(App.state.dashInterval);
            if (App.state.timer) clearInterval(App.state.timer);
            if (App.state.cheatInterval) clearInterval(App.state.cheatInterval);
            if (App.state.saveDebounce) clearTimeout(App.state.saveDebounce);

            App.state = {
              user: null, agendaId: null, mapelList: [], activeMapel: null, tempMapelId: null,
              soal: [], jawaban: [], ragu: [], endTime: 0, timer: null, currentSoalIdx: 0,
              dashInterval: null, cheatTimer: 30, cheatInterval: null, selectedLeftIndex: null,
              antiCheatInstalled: false, saveDebounce: null
            };

            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            App.ui.view('viewAuth');
          }
        });
      }
    };

    // DASHBOARD
    const Dashboard = {
      show: async () => {
        App.ui.view('viewDashboard');
        document.getElementById('dashNama').innerText = App.state.user.nama_peserta;
        document.getElementById('dashSekolah').innerText = App.state.user.asal_sekolah;

        document.getElementById('secAgenda').classList.remove('d-none');
        document.getElementById('secToken').classList.add('d-none');
        document.getElementById('secMapel').classList.add('d-none');

        const cont = document.getElementById('agendaListContainer');
        cont.innerHTML = `<div class="col-12 d-flex justify-content-center py-4"><div class="spinner-border" style="color: var(--primary)"></div></div>`;

        try {
          const res = await apiFetch('/api/agenda');
          cont.innerHTML = '';

          if (res.success && (res.data || []).length > 0) {
            if (App.state.dashInterval) clearInterval(App.state.dashInterval);

            res.data.forEach(a => {
              const safeName = JSON.stringify(a.agenda_ujian || '');
              cont.innerHTML += `
                <div class="col-md-6 col-lg-4">
                  <div class="agenda-card p-4 h-100">
                    <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
                      <div class="fw-black" style="font-weight:900;">${a.agenda_ujian}</div>
                      <span class="badge rounded-pill" style="background: rgba(220,38,38,.10); color: var(--primary); border:1px solid rgba(220,38,38,.25);">CBT</span>
                    </div>
                    <div class="small mb-3" style="color: var(--muted);">
                      Mulai: ${new Date(a.tgljam_mulai).toLocaleString()}
                    </div>
                    <div id="count-${a.id}" class="alert alert-light border text-center fw-bold mb-3" style="border-radius: 14px;">...</div>
                    <button id="btn-${a.id}" class="btn btn-primary-custom w-100 py-2" onclick="Dashboard.openToken(${a.id}, ${safeName})">
                      BUKA UJIAN
                    </button>
                  </div>
                </div>
              `;
            });

            const update = () => {
              const now = new Date().getTime();
              res.data.forEach(a => {
                const start = new Date(a.tgljam_mulai).getTime();
                const end = new Date(a.tgljam_selesai).getTime();
                const elC = document.getElementById(`count-${a.id}`);
                const elB = document.getElementById(`btn-${a.id}`);
                if (!elC) return;

                if (now < start) {
                  elC.innerText = 'Dimulai dlm: ' + Dashboard.fmt(start - now);
                  elC.className = 'alert alert-warning border text-center fw-bold mb-3';
                  elC.style.borderRadius = '14px';
                  elB.disabled = true;
                  elB.className = 'btn btn-secondary w-100 py-2';
                } else if (now >= start && now <= end) {
                  elC.innerText = 'Sisa Waktu: ' + Dashboard.fmt(end - now);
                  elC.className = 'alert alert-success border text-center fw-bold mb-3';
                  elC.style.borderRadius = '14px';
                  elB.disabled = false;
                  elB.className = 'btn btn-primary-custom w-100 py-2';
                } else {
                  elC.innerText = 'BERAKHIR';
                  elC.className = 'alert alert-danger border text-center fw-bold mb-3';
                  elC.style.borderRadius = '14px';
                  elB.disabled = true;
                  elB.className = 'btn btn-secondary w-100 py-2';
                }
              });
            };

            update();
            App.state.dashInterval = setInterval(update, 1000);
          } else {
            cont.innerHTML = '<div class="col-12 text-center" style="color: var(--muted);">Tidak ada agenda aktif.</div>';
          }
        } catch (err) {
          cont.innerHTML = `<div class="col-12 text-center text-danger">Gagal load agenda: ${err.message}</div>`;
        }
      },

      fmt: (ms) => {
        const d = Math.floor(ms / 86400000);
        const h = Math.floor((ms % 86400000) / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        return (d > 0 ? d + 'h ' : '') + h + 'j ' + m + 'm ' + s + 'd';
      },

      openToken: (id, name) => {
        App.state.agendaId = id;
        document.getElementById('secAgenda').classList.add('d-none');
        document.getElementById('secToken').classList.remove('d-none');
        document.getElementById('tokenAgendaName').innerText = name;
        document.getElementById('inputToken').value = '';
      },

      backToAgenda: () => {
        document.getElementById('secToken').classList.add('d-none');
        document.getElementById('secMapel').classList.add('d-none');
        document.getElementById('secAgenda').classList.remove('d-none');
      },

      verifyToken: async () => {
        const t = document.getElementById('inputToken').value.trim();
        if (!t) return;

        App.ui.load(true, 'Verifikasi Token...');
        try {
          const r = await apiFetch('/api/verify-token', {
            method: 'POST',
            body: { agenda_id: App.state.agendaId, token: t }
          });

          if (r.success) await Dashboard.refreshMapel();
          else {
            App.ui.load(false);
            Swal.fire({ icon: 'error', title: 'Gagal', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      },

      refreshMapel: async () => {
        try {
          const r = await apiFetch('/api/mapel', {
            query: { agenda_id: App.state.agendaId, peserta_id: App.state.user.id }
          });
          App.ui.load(false);
          if (r.success) {
            App.state.mapelList = r.data || [];
            Dashboard.showMapel();
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      },

      showMapel: () => {
        document.getElementById('secToken').classList.add('d-none');
        document.getElementById('secMapel').classList.remove('d-none');

        const cont = document.getElementById('mapelListContainer');
        cont.innerHTML = '';

        App.state.mapelList.forEach(m => {
          let status = m.status_kerjakan;
          if (status) status = status.trim();

          let btn = '';
          let cardClass = '';

          if (status === 'Selesai') {
            btn = `<button class="btn btn-secondary w-100 rounded-3 py-2 fw-bold" disabled><i class="bi bi-check-circle-fill"></i> SELESAI</button>`;
            cardClass = 'border-success';
          } else if (status === 'Proses' || status === 'Lanjut') {
            btn = `<button class="btn btn-warning text-white w-100 rounded-3 py-2 fw-bold" onclick="Exam.confirm(${m.id})"><i class="bi bi-play-fill"></i> LANJUTKAN</button>`;
            cardClass = 'border-warning';
          } else {
            btn = `<button class="btn btn-primary-custom w-100 rounded-3 py-2 fw-bold" onclick="Exam.confirm(${m.id})"><i class="bi bi-play-fill me-1"></i> MULAI</button>`;
          }

          cont.innerHTML += `
            <div class="col-md-6">
              <div class="agenda-card p-3 h-100 ${cardClass}">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-black mb-1" style="font-weight:900;">${m.nama_mata_pelajaran}</div>
                    <div class="small" style="color: var(--muted);">
                      <i class="bi bi-clock"></i> ${m.durasi_ujian} Menit &nbsp;â€¢&nbsp;
                      <i class="bi bi-file-text"></i> ${m.jumlah_soal} Soal
                    </div>
                  </div>
                  <div style="width:150px">${btn}</div>
                </div>
              </div>
            </div>
          `;
        });
      }
    };

    // EXAM ENGINE
    const Exam = {
      confirm: (mid) => {
        App.state.tempMapelId = mid;
        document.getElementById('checkAgree').checked = false;
        document.getElementById('btnStartReal').disabled = true;
        new bootstrap.Modal(document.getElementById('modalRules')).show();
        document.getElementById('checkAgree').onchange = (e) => {
          document.getElementById('btnStartReal').disabled = !e.target.checked;
        };
      },

      startReal: async () => {
        bootstrap.Modal.getInstance(document.getElementById('modalRules')).hide();
        App.ui.load(true, 'Menyiapkan Soal...');

        try {
          const r = await apiFetch('/api/get-soal', {
            method: 'POST',
            body: {
              agenda_id: App.state.agendaId,
              peserta_id: App.state.user.id,
              mapel_id: App.state.tempMapelId
            }
          });

          App.ui.load(false);

          if (r.success) {
            if (r.status === 'Selesai') {
              Swal.fire({ icon: 'info', title: 'Info', text: 'Ujian ini sudah Anda selesaikan.', confirmButtonColor: '#dc2626' })
                .then(() => Dashboard.refreshMapel());
              return;
            }

            App.state.soal = r.data_soal;
            App.state.activeMapel = r.mapel_detail;
            App.state.jawaban = r.jawaban_sebelumnya ? r.jawaban_sebelumnya.split('|') : Array(r.data_soal.length).fill('-');
            App.state.ragu = Array(r.data_soal.length).fill(false);
            App.state.endTime = new Date(r.waktu_mulai).getTime() + (r.mapel_detail.durasi_ujian * 60000);

            App.ui.view('viewUjian');
            App.state.currentSoalIdx = 0;
            Exam.renderSoal();
            Exam.timer();
            Exam.antiCheat();
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      },

      renderSoal: () => {
        const s = App.state.soal[App.state.currentSoalIdx];
        const j = App.state.jawaban[App.state.currentSoalIdx];
        const rawType = s.type_soal || 'Pilihan Ganda';
        const type = rawType.trim();

        document.getElementById('ujianMapelName').innerText = App.state.activeMapel.nama_mata_pelajaran || 'Ujian';
        document.getElementById('checkRagu').checked = App.state.ragu[App.state.currentSoalIdx];

        let h = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="badge rounded-pill px-3 py-2 fs-6" style="background: rgba(220,38,38,.10); color: var(--primary); border:1px solid rgba(220,38,38,.25);">
              Soal No ${App.state.currentSoalIdx + 1}
            </span>
            <span class="badge bg-light text-dark border fs-6" style="border-radius: 999px;">${type}</span>
          </div>
        `;

        if (s.gambar_url) {
          h += `<div class="text-center mb-3"><img src="${s.gambar_url}" class="img-fluid rounded shadow-sm" style="max-height:320px"></div>`;
        }
        h += `<div class="fs-5 mb-3 lh-base">${s.pertanyaan}</div>`;

        // 1) PG Kompleks
        if (type.includes('Kompleks')) {
          h += `<div class="alert alert-info py-2 small mb-3"><i class="bi bi-info-circle"></i> Pilih lebih dari satu jawaban.</div>`;
          ['a','b','c','d','e'].forEach(o => {
            const txt = s[`pilihan_${o}`];
            if (txt && txt !== "") {
              const isChecked = (j || '').includes(o.toUpperCase());
              const selClass = isChecked ? 'selected' : '';
              const icon = isChecked ? '<i class="bi bi-check-square-fill" style="color: var(--primary); font-size: 1.2rem;"></i>' : '<i class="bi bi-square" style="color: var(--muted); font-size: 1.2rem;"></i>';
              h += `<div class="option-item ${selClass}" onclick="Exam.ansPGComplex('${o.toUpperCase()}')"><div class="option-label">${o.toUpperCase()}</div><div class="flex-grow-1">${txt}</div><div>${icon}</div></div>`;
            }
          });
        }

        // 2) Tabel Benar/Salah atau Setuju/Tidak
        else if (type.includes('Benar') || type.includes('Salah') || type.includes('Setuju') || type.includes('Tidak')) {
          const isBS = (type.includes('Benar') || type.includes('Salah'));
          const col1 = isBS ? 'Benar (B)' : 'Setuju (S)';
          const col2 = isBS ? 'Salah (S)' : 'Tidak (T)';
          const val1 = isBS ? 'B' : 'S';
          const val2 = isBS ? 'S' : 'T';

          h += `<div class="table-responsive"><table class="table table-bordered align-middle">
            <thead class="table-light text-center">
              <tr><th class="text-start">Pernyataan</th><th style="width:120px">${col1}</th><th style="width:120px">${col2}</th></tr>
            </thead><tbody>`;

          let adaPernyataan = false;
          for (let i=1; i<=8; i++) {
            const txt = s[`pernyataan_${i}`];
            if (txt && txt !== "") {
              adaPernyataan = true;
              const dataIndex = i - 1;
              const currentVal = (j && j.length > dataIndex) ? j[dataIndex] : '-';

              h += `<tr>
                <td class="align-middle">${txt}</td>
                <td class="text-center align-middle">
                  <input type="radio" class="form-check-input fs-4" style="cursor:pointer" name="row_${dataIndex}" ${currentVal === val1 ? 'checked' : ''} onclick="Exam.ansTable(${dataIndex}, '${val1}')">
                </td>
                <td class="text-center align-middle">
                  <input type="radio" class="form-check-input fs-4" style="cursor:pointer" name="row_${dataIndex}" ${currentVal === val2 ? 'checked' : ''} onclick="Exam.ansTable(${dataIndex}, '${val2}')">
                </td>
              </tr>`;
            }
          }
          if (!adaPernyataan) {
            h += `<tr><td colspan="3" class="text-center text-danger p-3"><em>Data pernyataan kosong. Cek kolom pernyataan_1 s.d pernyataan_8 di database.</em></td></tr>`;
          }
          h += `</tbody></table></div>`;
        }

        // 3) Penjodohan
        else if (type.includes('Penjodohan') || type.includes('Menjodohkan')) {
          h += `<div class="alert alert-info py-2 small mb-3"><i class="bi bi-info-circle"></i> Klik kiri, lalu klik kanan untuk menjodohkan.</div>`;

          const leftStatements = [];
          const rightStatements = [];
          for (let i=1; i<=8; i++) {
            if (s[`pernyataan_kiri_${i}`] && s[`pernyataan_kiri_${i}`].trim() !== '') leftStatements.push({ index: i, text: s[`pernyataan_kiri_${i}`] });
            if (s[`pernyataan_kanan_${i}`] && s[`pernyataan_kanan_${i}`].trim() !== '') rightStatements.push({ letter: String.fromCharCode(64 + i), text: s[`pernyataan_kanan_${i}`] });
          }

          App.state.selectedLeftIndex = null;

          h += `<div class="connection-grid">
            <div class="connection-column">
              <h6>Pernyataan</h6>
              ${leftStatements.map(item => `<div class="connection-item left-item" data-index="${item.index}" onclick="Exam.handleConnectionClick(event)">${item.index}. ${item.text}</div>`).join('')}
            </div>
            <div class="connection-column">
              <h6>Pilihan</h6>
              ${rightStatements.map(item => `<div class="connection-item right-item" data-letter="${item.letter}" onclick="Exam.handleConnectionClick(event)">${item.letter}. ${item.text}</div>`).join('')}
            </div>
          </div>
          <div class="connection-display">
            <h6>Hasil Jodohan:</h6>
            <div id="connection-list"></div>
          </div>`;
        }

        // 4) Essay
        else if (type.includes('Uraian') || type.includes('Essay')) {
          h += `<textarea class="form-control p-3" style="border-radius: 14px;" rows="6" placeholder="Ketik jawaban Anda disini..." oninput="Exam.ansEssay(this.value)">${j === '-' ? '' : (j || '')}</textarea>`;
        }

        // 5) Default PG tunggal
        else {
          ['a','b','c','d','e'].forEach(o => {
            const txt = s[`pilihan_${o}`];
            if (txt && txt !== "") {
              const sel = j === o.toUpperCase() ? 'selected' : '';
              h += `<div class="option-item ${sel}" onclick="Exam.ansPGSingle('${o.toUpperCase()}')"><div class="option-label">${o.toUpperCase()}</div><div class="flex-grow-1">${txt}</div></div>`;
            }
          });
        }

        document.getElementById('soalContainer').innerHTML = h;
        if (type.includes('Penjodohan')) Exam.renderConnections();
        Exam.navUpdate();
      },

      ansPGSingle: (val) => { Exam.saveAnswer(val); Exam.renderSoal(); },

      ansPGComplex: (val) => {
        let current = App.state.jawaban[App.state.currentSoalIdx];
        if (current === '-') current = '';
        let arr = current.split('');
        if (arr.includes(val)) arr = arr.filter(x => x !== val);
        else arr.push(val);
        let newVal = arr.sort().join('');
        if (newVal === '') newVal = '-';
        Exam.saveAnswer(newVal);
        Exam.renderSoal();
      },

      ansTable: (rowIndex, val) => {
        let current = App.state.jawaban[App.state.currentSoalIdx];
        const s = App.state.soal[App.state.currentSoalIdx];

        let statementCount = 0;
        for (let i=1; i<=8; i++) {
          if (s[`pernyataan_${i}`] && s[`pernyataan_${i}`].trim() !== '') statementCount++;
        }

        if (!current || current === '-' || current.length < statementCount) current = Array(statementCount).fill('-').join('');
        let arr = current.split('');
        arr[rowIndex] = val;
        Exam.saveAnswer(arr.join(''));
        Exam.navUpdate();
      },

      handleConnectionClick: (event) => {
        const target = event.target;
        if (!target.classList.contains('connection-item')) return;

        const isLeft = target.classList.contains('left-item');
        const isRight = target.classList.contains('right-item');

        if (isLeft) {
          document.querySelectorAll('.left-item').forEach(item => item.classList.remove('active-left'));
          target.classList.add('active-left');
          App.state.selectedLeftIndex = target.dataset.index;
        } else if (isRight && App.state.selectedLeftIndex) {
          const leftIndex = App.state.selectedLeftIndex;
          const rightLetter = target.dataset.letter;
          Exam.updateConnection(leftIndex, rightLetter);
        }
      },

      updateConnection: (leftIndex, rightLetter) => {
        let answerString = App.state.jawaban[App.state.currentSoalIdx] || '-';
        const answers = {};
        if (answerString !== '-') {
          for (let i=0; i<answerString.length; i+=2) {
            const num = answerString.substring(i, i+1);
            const letter = answerString.substring(i+1, i+2);
            answers[num] = letter;
          }
        }

        if (answers[leftIndex] === rightLetter) delete answers[leftIndex];
        else answers[leftIndex] = rightLetter;

        App.state.selectedLeftIndex = null;
        document.querySelectorAll('.left-item').forEach(item => item.classList.remove('active-left'));

        const newAnswerString = Object.keys(answers)
          .map(Number)
          .sort((a, b) => a - b)
          .map(num => `${num}${answers[num]}`)
          .join('');

        Exam.saveAnswer(newAnswerString || '-');
        Exam.renderConnections();
      },

      renderConnections: () => {
        const answerString = App.state.jawaban[App.state.currentSoalIdx] || '-';
        const answers = {};
        if (answerString !== '-') {
          for (let i=0; i<answerString.length; i+=2) {
            const num = answerString.substring(i, i+1);
            const letter = answerString.substring(i+1, i+2);
            answers[num] = letter;
          }
        }

        document.querySelectorAll('.connection-item').forEach(item => item.classList.remove('connected'));

        Object.keys(answers).forEach(num => {
          const letter = answers[num];
          const leftEl = document.querySelector(`.left-item[data-index="${num}"]`);
          const rightEl = document.querySelector(`.right-item[data-letter="${letter}"]`);
          if (leftEl) leftEl.classList.add('connected');
          if (rightEl) rightEl.classList.add('connected');
        });

        const listContainer = document.getElementById('connection-list');
        if (listContainer) {
          listContainer.innerHTML = '';
          if (Object.keys(answers).length === 0) {
            listContainer.innerHTML = '<span style="color: var(--muted);">Belum ada jodohan.</span>';
          } else {
            Object.keys(answers).forEach(num => {
              const letter = answers[num];
              listContainer.innerHTML += `<span class="connection-list-item">${num} â†’ ${letter}</span>`;
            });
          }
        }
      },

      ansEssay: (val) => { Exam.saveAnswer(val); },

      queueSaveToServer: () => {
        if (App.state.saveDebounce) clearTimeout(App.state.saveDebounce);
        App.state.saveDebounce = setTimeout(async () => {
          try {
            const str = App.state.jawaban.map(j => j || '-').join('|');
            await apiFetch('/api/save-jawaban', {
              method: 'POST',
              body: {
                pid: App.state.user.id,
                aid: App.state.agendaId,
                mid: App.state.activeMapel.id,
                jwb: str
              }
            });
          } catch (e) {
            console.warn('Autosave gagal:', e.message);
          }
        }, 800);
      },

      saveAnswer: (val) => {
        App.state.jawaban[App.state.currentSoalIdx] = val || '-';
        App.data.save(`ans_${App.state.activeMapel.id}`, App.state.jawaban);
        Exam.navUpdate();
        Exam.queueSaveToServer();
      },

      toggleRagu: () => {
        App.state.ragu[App.state.currentSoalIdx] = document.getElementById('checkRagu').checked;
        Exam.navUpdate();
      },

      navSoal: (d) => {
        const next = App.state.currentSoalIdx + d;
        App.state.currentSoalIdx = Math.max(0, Math.min(next, App.state.soal.length - 1));
        Exam.renderSoal();
      },

      navUpdate: () => {
        document.getElementById('btnPrev').disabled = App.state.currentSoalIdx === 0;

        const bn = document.getElementById('btnNext');
        if (App.state.currentSoalIdx === App.state.soal.length - 1) {
          bn.innerHTML = 'SELESAI';
          bn.className = 'btn btn-danger rounded-pill fw-bold px-4';
          bn.onclick = () => Exam.finish(false);
        } else {
          bn.innerHTML = 'Selanjutnya';
          bn.className = 'btn btn-danger rounded-pill fw-bold px-4';
          bn.onclick = () => Exam.navSoal(1);
        }

        const g = document.getElementById('navGridDesktop');
        g.innerHTML = '';
        App.state.soal.forEach((_, i) => {
          let c = '';
          if (i === App.state.currentSoalIdx) c = 'active';
          else if (App.state.ragu[i]) c = 'ragu';
          else if (App.state.jawaban[i] && App.state.jawaban[i] !== '-') c = 'filled';

          g.innerHTML += `<button class="nav-item-btn ${c}" onclick="App.state.currentSoalIdx=${i};Exam.renderSoal()">${i + 1}</button>`;
        });
      },

      timer: () => {
        if (App.state.timer) clearInterval(App.state.timer);
        App.state.timer = setInterval(() => {
          const diff = App.state.endTime - Date.now();
          if (diff < 0) {
            clearInterval(App.state.timer);
            Exam.finish(true);
            return;
          }
          const h = Math.floor(diff / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          const timerEl = document.getElementById('timerDisplay');
          timerEl.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
          if (diff < 300000) timerEl.classList.add('timer-warning');
        }, 1000);
      },

      antiCheat: () => {
        if (App.state.antiCheatInstalled) return;
        App.state.antiCheatInstalled = true;

        document.addEventListener('visibilitychange', () => {
          if (document.hidden && !document.getElementById('viewUjian').classList.contains('d-none')) {
            new bootstrap.Modal(document.getElementById('modalViolation')).show();
            App.state.cheatTimer = 30;
            document.getElementById('violationTimer').innerText = 30;
            document.getElementById('btnResumeExam').classList.remove('d-none');
            document.getElementById('btnForceFinish').classList.add('d-none');

            if (App.state.cheatInterval) clearInterval(App.state.cheatInterval);
            App.state.cheatInterval = setInterval(() => {
              App.state.cheatTimer--;
              document.getElementById('violationTimer').innerText = App.state.cheatTimer;
              if (App.state.cheatTimer <= 0) {
                clearInterval(App.state.cheatInterval);
                document.getElementById('violationTimer').innerText = "WAKTU HABIS";
                document.getElementById('btnResumeExam').classList.add('d-none');
                document.getElementById('btnForceFinish').classList.remove('d-none');
                document.getElementById('btnForceFinish').onclick = () => Exam.finish(true);
              }
            }, 1000);
          }
        });
      },

      resume: () => {
        clearInterval(App.state.cheatInterval);
        bootstrap.Modal.getInstance(document.getElementById('modalViolation')).hide();
      },

      finish: async (force) => {
        if (!force) {
          const ok = await Swal.fire({
            icon: 'question',
            title: 'Selesaikan Ujian?',
            text: 'Pastikan semua jawaban sudah benar. Setelah selesai, status akan dikunci.',
            showCancelButton: true,
            confirmButtonText: 'Ya, Selesaikan',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#dc2626'
          }).then(r => r.isConfirmed);
          if (!ok) return;
        }

        App.ui.load(true, 'Menyimpan...');
        clearInterval(App.state.timer);
        clearInterval(App.state.cheatInterval);

        const str = App.state.jawaban.map(j => j || '-').join('|');

        try {
          const r = await apiFetch('/api/selesai-ujian', {
            method: 'POST',
            body: {
              pid: App.state.user.id,
              aid: App.state.agendaId,
              mid: App.state.activeMapel.id,
              jwb: str
            }
          });

          App.ui.load(false);
          const vModal = bootstrap.Modal.getInstance(document.getElementById('modalViolation'));
          if (vModal) vModal.hide();

          if (r.success) {
            Swal.fire({ icon: 'success', title: 'Sukses', text: 'Ujian telah selesai dan disimpan.', confirmButtonColor: '#10b981' })
              .then(() => Dashboard.refreshMapel());
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: r.message, confirmButtonColor: '#dc2626' });
          }
        } catch (err) {
          App.ui.load(false);
          Swal.fire({ icon: 'error', title: 'Error', text: err.message, confirmButtonColor: '#dc2626' });
        }
      }
    };

    // EXPORTS
    window.loadAgendaDropdown = Auth.loadAgendas;
    window.downloadKartu = () => html2canvas(document.getElementById('kartuArea')).then(c => {
      const a = document.createElement('a');
      a.download = 'Kartu Peserta CBT PRO.png';
      a.href = c.toDataURL();
      a.click();
    });
    window.tutupKartuKeLogin = () => {
      bootstrap.Modal.getInstance(document.getElementById('modalKartu')).hide();
      document.querySelector('[data-bs-target="#tabLogin"]').click();
    };

    window.Auth = Auth;
    window.Dashboard = Dashboard;
    window.Exam = Exam;
    window.Ui = Ui;
    window.Theme = Theme;

    window.onload = Auth.init;
  </script>
</body>
</html>
